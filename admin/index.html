<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YDE Senior Fund Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Define the core dark color scheme for consistency */
        .primary-dark { background-color: #0d1222; }
        .accent-yellow { color: #facc15; }
        .card-dark { background-color: #1f2937; }

        body { 
            font-family: 'Inter', sans-serif; 
            color: #ffffff; /* Default text white */
            background-color: #0d1222;
            background-image: linear-gradient(135deg, #0d1222 0%, #151a2d 100%);
        }
        .dashboard-card {
            background-color: #1f2937; /* Dark card color */
            border-radius: 0.75rem;
            box-shadow: 0 8px 16px -4px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.05); /* Darker shadow, subtle white border */
            transition: all 0.3s ease;
        }
        .tab-button.active {
            border-bottom: 3px solid #facc15; /* Tailwind yellow-400 */
            color: #facc15; /* Active text is yellow */
            font-weight: 600;
        }
        .data-table th {
            text-align: left;
            padding: 0.75rem 1rem;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #9ca3af; /* Light gray text */
            background-color: #374151; /* Darker header background */
            border-bottom: 2px solid #4b5563; /* Dark border */
            cursor: pointer;
        }
        .data-table td {
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            border-bottom: 1px solid #374151; /* Dark border */
            color: #d1d5db; /* Light gray text for data */
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.75); /* Darker overlay */
            backdrop-filter: blur(8px);
        }
        /* Custom scrollbar for better appearance on table containers */
        .overflow-x-auto::-webkit-scrollbar { height: 8px; }
        .overflow-x-auto::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 4px; }
        .overflow-x-auto::-webkit-scrollbar-track { background-color: #1f2937; }
        .referrer-sort-header { user-select: none; }
        .sort-icon { display: none; }
        .sort-header.active .sort-icon { display: inline-block; }
    </style>
</head>
<body class="min-h-screen">

    <!-- Global Loading Overlay -->
    <div id="globalLoadingOverlay" class="fixed inset-0 z-50 bg-slate-900/80 backdrop-blur-sm flex flex-col items-center justify-center gap-4 hidden">
        <div class="animate-spin w-10 h-10 border-4 border-t-4 border-yellow-400 border-opacity-20 rounded-full"></div>
        <p id="globalSpinnerText" class="text-white font-semibold">Checking authorization...</p>
    </div>

    <!-- Custom Popup Modal -->
    <div id="customPopupOverlay" class="fixed inset-0 z-[101] modal-overlay flex items-center justify-center p-4 hidden">
        <div id="customPopup" class="bg-gray-800 p-6 rounded-lg shadow-2xl max-w-sm w-full text-center scale-95 transition-all duration-300">
            <h2 id="popupTitle" class="text-2xl font-bold text-yellow-400 mb-3"></h2>
            <p id="popupMessage" class="text-gray-300 mb-5"></p>
            <button id="popupCloseButton" class="w-full py-2 rounded-lg bg-yellow-500 text-black font-semibold hover:bg-yellow-600 transition-colors">OK</button>
        </div>
    </div>
    
    <!-- Batch Password Reset Modal (Super Admin Only) -->
    <div id="batchResetModalOverlay" class="fixed inset-0 z-50 modal-overlay flex items-center justify-center p-4 hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow-2xl max-w-md w-full">
            <h2 class="text-2xl font-bold text-red-400 mb-4">Batch Password Reset</h2>
            <p class="text-gray-300 mb-4">
                You are about to reset the password for <span id="selectedUserCount" class="font-bold text-red-400">0</span> user(s).
            </p>
            <form id="batchResetForm" class="space-y-4">
                <div>
                    <label for="batch-new-password" class="block text-sm font-medium text-gray-300">Temporary New Password (min 6 chars)</label>
                    <input type="password" id="batch-new-password" placeholder="Enter new password" class="w-full p-3 border border-gray-600 rounded-lg focus:ring-red-500 focus:border-red-500 bg-gray-700 text-white" required minlength="6">
                </div>
                <div class="pt-4 flex justify-end space-x-3">
                    <button type="button" id="closeBatchResetModal" class="px-4 py-2 text-gray-300 bg-gray-600 rounded-lg hover:bg-gray-500 transition-colors">Cancel</button>
                    <button type="submit" id="submitBatchReset" class="px-4 py-2 text-white bg-red-500 rounded-lg hover:bg-red-600 transition-colors disabled:opacity-50">
                        Confirm Reset
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- MISSING MODAL: Manual Sale Modal (Super Admin Only) -->
    <div id="manualSaleModalOverlay" class="fixed inset-0 z-50 modal-overlay flex items-center justify-center p-4 hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow-2xl max-w-md w-full">
            <h2 class="text-2xl font-bold text-white mb-4">Add Manual Raffle Sale (SA Only)</h2>
            <form id="manualSaleForm" class="space-y-4">
                <div>
                    <input type="text" id="manual-name" placeholder="Customer Full Name" class="w-full p-3 border border-gray-600 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 bg-gray-700 text-white" required>
                </div>
                <div>
                    <input type="email" id="manual-email" placeholder="Customer Email (Optional)" class="w-full p-3 border border-gray-600 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 bg-gray-700 text-white">
                </div>
                <div>
                    <input type="tel" id="manual-phone" placeholder="Customer Phone (Optional)" class="w-full p-3 border border-gray-600 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 bg-gray-700 text-white">
                </div>
                <div class="flex space-x-4">
                    <input type="number" id="manual-tickets" placeholder="Tickets Bought" min="1" class="w-1/2 p-3 border border-gray-600 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 bg-gray-700 text-white" required>
                    <input type="number" id="manual-amount" placeholder="Amount Paid ($)" step="0.01" min="0.01" class="w-1/2 p-3 border border-gray-600 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 bg-gray-700 text-white" required>
                </div>
                <div id="manual-referrer-container" class="hidden">
                    <input type="text" id="manual-refId" placeholder="Referrer ID (e.g., A1B2C3)" class="w-full p-3 border border-gray-600 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 bg-gray-700 text-white">
                    <p class="text-xs text-gray-400 mt-1">Credited to this Ref ID.</p>
                </div>
                <div class="pt-4 flex justify-end space-x-3">
                    <button type="button" id="closeManualSaleModal" class="px-4 py-2 text-gray-300 bg-gray-600 rounded-lg hover:bg-gray-500 transition-colors">Cancel</button>
                    <button type="submit" id="submitManualSale" class="px-4 py-2 text-black bg-yellow-500 rounded-lg hover:bg-yellow-600 transition-colors font-semibold">Add Sale</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- MISSING MODAL: Edit Raffle Sale Modal (Super Admin Only) -->
    <div id="editSaleModalOverlay" class="fixed inset-0 z-50 modal-overlay flex items-center justify-center p-4 hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow-2xl max-w-md w-full">
            <h2 class="text-2xl font-bold text-white mb-4">Edit Raffle Sale Entry </h2>
            <form id="editSaleForm" class="space-y-4">
                <input type="hidden" id="edit-sale-id">
                <div>
                    <label for="edit-name" class="block text-sm font-medium text-gray-300">Customer Full Name</label>
                    <input type="text" id="edit-name" placeholder="Full Name" class="w-full p-3 border border-gray-600 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 bg-gray-700 text-white" required>
                </div>
                <div>
                    <label for="edit-email" class="block text-sm font-medium text-gray-300">Email</label>
                    <input type="email" id="edit-email" placeholder="Email (Optional)" class="w-full p-3 border border-gray-600 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 bg-gray-700 text-white">
                </div>
                <div>
                    <label for="edit-phone" class="block text-sm font-medium text-gray-300">Phone</label>
                    <input type="tel" id="edit-phone" placeholder="Phone (Optional)" class="w-full p-3 border border-gray-600 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 bg-gray-700 text-white">
                </div>
                <div class="flex space-x-4">
                    <div class="w-1/2">
                        <label for="edit-tickets" class="block text-sm font-medium text-gray-300">Tickets Bought</label>
                        <input type="number" id="edit-tickets" placeholder="Tickets Bought" min="1" class="w-full p-3 border border-gray-600 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 bg-gray-700 text-white" required>
                    </div>
                    <div class="w-1/2">
                        <label for="edit-amount" class="block text-sm font-medium text-gray-300">Amount Paid ($)</label>
                        <input type="number" id="edit-amount" placeholder="Amount Paid ($)" step="0.01" min="0.01" class="w-full p-3 border border-gray-600 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 bg-gray-700 text-white" required>
                    </div>
                </div>
                <div class="pt-4 flex justify-end space-x-3">
                    <button type="button" id="closeEditSaleModal" class="px-4 py-2 text-gray-300 bg-gray-600 rounded-lg hover:bg-gray-500 transition-colors">Cancel</button>
                    <button type="submit" id="submitEditSale" class="px-4 py-2 text-white bg-blue-500 rounded-lg hover:bg-blue-600 transition-colors">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MISSING MODAL: Apply Raffle Tickets Modal (Split the Pot) - Super Admin Only -->
    <div id="applyTicketsModalOverlay" class="fixed inset-0 z-50 modal-overlay flex items-center justify-center p-4 hidden">
        <div class="bg-gray-800 p-8 rounded-lg shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold text-white mb-2">Assign/Transfer Split The Pot Tickets to: <span id="targetReferrerName" class="text-blue-400"></span></h2>
            <p class="text-sm text-gray-400 mb-4">Select sales below to assign (if unassigned) or transfer (if already assigned) them to this referrer's ID (<span id="targetReferrerId"></span>).</p>

            <!-- Search and Action Bar -->
            <div class="flex flex-col md:flex-row gap-3 md:items-center mb-4">
                <input type="text" id="unassignedSearchInput" placeholder="Search customer, phone, email, or current referrer ID..." class="w-full md:w-1/2 p-3 border border-gray-600 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 bg-gray-700 text-white">
                <div class="flex-grow"></div>
                <span id="selectedCountDisplay" class="text-sm font-medium text-gray-400">0 sales selected</span>
                <button id="applyReferrerButton" class="px-4 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition-colors disabled:opacity-50" disabled>
                    Apply Referrer to Selected
                </button>
            </div>

            <!-- Unassigned Sales Table -->
            <div class="overflow-x-auto dashboard-card max-h-[50vh]">
                <table class="data-table w-full whitespace-nowrap">
                    <thead>
                        <tr>
                            <th class="w-12 text-center">
                                <input type="checkbox" id="selectAllUnassigned" class="rounded text-blue-400 focus:ring-blue-400 bg-gray-700 border-gray-600">
                            </th>
                            <th>Date</th>
                            <th>Full Name</th>
                            <th>Phone/Email</th>
                            <th>Tickets</th>
                            <th class="text-right">Amount Paid</th>
                            <th>Current Referrer</th>
                        </tr>
                    </thead>
                    <tbody id="unassignedSalesTableBody">
                        <tr><td colspan="7" class="text-center py-4 text-gray-400">Loading sales data...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="pt-6 flex justify-end">
                <button type="button" id="closeApplyTicketsModal" class="px-4 py-2 text-gray-300 bg-gray-600 rounded-lg hover:bg-gray-500 transition-colors">Close</button>
            </div>
        </div>
    </div>
    
    <!-- MISSING MODAL: Apply Rolex Tickets Modal (Spin the Wheel) - Super Admin Only -->
    <div id="applyRolexTicketsModalOverlay" class="fixed inset-0 z-50 modal-overlay flex items-center justify-center p-4 hidden">
        <div class="bg-gray-800 p-8 rounded-lg shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold text-white mb-2">Assign/Transfer Spin The Wheel Tickets to: <span id="targetRolexReferrerName" class="text-purple-400"></span></h2>
            <p class="text-sm text-gray-400 mb-4">Select tickets below to assign or transfer them to this referrer's ID (<span id="targetRolexReferrerId"></span>). Tickets must be Paid or Claimed.</p>

            <!-- Search and Action Bar -->
            <div class="flex flex-col md:flex-row gap-3 md:items-center mb-4">
                <input type="text" id="rolexSearchInput" placeholder="Search customer, email, or current referrer ID..." class="w-full md:w-1/2 p-3 border border-gray-600 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 bg-gray-700 text-white">
                <div class="flex-grow"></div>
                <span id="selectedRolexCountDisplay" class="text-sm font-medium text-gray-400">0 tickets selected</span>
                <button id="applyRolexReferrerButton" class="px-4 py-2 bg-purple-500 text-white font-semibold rounded-lg shadow-md hover:bg-purple-600 transition-colors disabled:opacity-50" disabled>
                    Apply Referrer to Selected
                </button>
            </div>

            <!-- Rolex Sales Table -->
            <div class="overflow-x-auto dashboard-card max-h-[50vh]">
                <table class="data-table w-full whitespace-nowrap">
                    <thead>
                        <tr>
                            <th class="w-12 text-center">
                                <input type="checkbox" id="selectAllRolex" class="rounded text-purple-400 focus:ring-purple-400 bg-gray-700 border-gray-600">
                            </th>
                            <th>Ticket #</th>
                            <th>Date</th>
                            <th>Full Name</th>
                            <th>Email/Phone</th>
                            <th>Status</th>
                            <th class="sort-header text-right" data-table="rolex" data-sort-key="amountPaid">Amount Paid <span class="sort-icon ml-1"></span></th>
                            <th class="sort-header" data-table="rolex" data-sort-key="referrerRefId">Referrer <span class="sort-icon ml-1"></span></th>
                        </tr>
                    </thead>
                    <tbody id="rolexAssignmentTableBody">
                        <tr><td colspan="7" class="text-center py-4 text-gray-400">Loading Spin The Wheel data...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="pt-6 flex justify-end">
                <button type="button" id="closeApplyRolexTicketsModal" class="px-4 py-2 text-gray-300 bg-gray-600 rounded-lg hover:bg-gray-500 transition-colors">Close</button>
            </div>
        </div>
    </div>
    
    <!-- MISSING MODAL: Upgrade Admin Confirmation Modal (Super Admin Only) -->
    <div id="upgradeAdminModalOverlay" class="fixed inset-0 z-50 modal-overlay flex items-center justify-center p-4 hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow-2xl max-w-sm w-full">
            <h2 class="text-2xl font-bold text-red-400 mb-4">Confirm Role Change</h2>
            <p class="text-gray-300 mb-6">
                Are you sure you want to promote <span id="upgrade-referrer-name" class="font-bold text-white"></span>
                (<span id="upgrade-referrer-refid" class="font-mono text-xs bg-gray-700 p-1 rounded"></span>)
                to a **Super Admin**?
            </p>
            <p class="text-sm text-red-400 mb-4">This action grants full system access and requires them to re-login.</p>
            <input type="hidden" id="upgrade-referrer-uid">
            
            <div class="pt-4 flex justify-end space-x-3">
                <button type="button" id="closeUpgradeAdminModal" class="px-4 py-2 text-gray-300 bg-gray-600 rounded-lg hover:bg-gray-500 transition-colors">Cancel</button>
                <button type="button" id="confirmUpgradeAdmin" class="px-4 py-2 text-white bg-red-500 rounded-lg hover:bg-red-600 transition-colors">Confirm Promote</button>
            </div>
        </div>
    </div>


    <!-- Main Dashboard Container -->
    <div id="dashboardContainer" class="hidden max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 border-b border-gray-700 pb-4">
            <h1 class="text-3xl font-bold text-white mb-2 md:mb-0">
                Admin Dashboard 
                <span id="userRoleDisplay" class="text-base font-normal text-yellow-400"></span>
            </h1>
            <div class="flex items-center space-x-3">
                <!-- EXPORT BUTTON (New) -->
                <button id="exportDataButton" class="flex items-center px-4 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition-colors hidden" title="Export current table view to CSV">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                    Export CSV
                </button>
                <!-- REFRESH BUTTON -->
                <button id="refreshDataButton" class="flex items-center px-4 py-2 bg-gray-700 text-white font-semibold rounded-lg shadow-md hover:bg-gray-600 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.76 2.82"></path><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.76-2.82"></path><path d="M3 3v4h4M21 21v-4h-4"></path></svg>
                    Refresh Data
                </button>
                <button id="addManualSaleButton" class="flex items-center px-4 py-2 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 transition-colors hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    Add Manual Sale
                </button>
                <button id="logoutButton" class="px-3 py-2 text-sm text-gray-300 bg-gray-600 rounded-lg hover:bg-gray-500 transition-colors">Logout</button>
            </div>
        </header>

        <!-- Referrer Overview (For Referrers and Super Admins) -->
        <div id="referrerOverview" class="dashboard-card p-6 mb-6 hidden">
            <!-- New Referral Link Section -->
            <div id="referrerLinkContainer" class="mb-4">
                <p class="text-sm font-medium text-gray-400 mb-1">Your Referral Link:</p>
                <div class="flex items-center bg-gray-700 p-2 rounded-lg border border-gray-600">
                    <span id="referralLink" class="text-base font-mono text-blue-400 truncate mr-3 select-all"></span>
                    <button id="copyLinkButton" class="ml-auto p-1 text-gray-400 hover:text-blue-500 transition-colors" title="Copy Link">
                               <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M7.75 3.75a.75.75 0 0 1 1.5 0v3.5h3.5a.75.75 0 0 1 0 1.5h-3.5v3.5a.75.75 0 0 1-1.5 0v-3.5h-3.5a.75.75 0 0 1 0-1.5h3.5v-3.5Z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
            </div>
            
            <h2 class="text-2xl font-bold text-white mb-4">Your Performance</h2>
            <div class="grid grid-cols-1 sm:grid-cols-4 gap-4">
                <!-- NEW: Total Clicks Card -->
                <div class="p-4 bg-purple-900/50 border-l-4 border-purple-500 rounded-lg">
                    <p class="text-sm font-medium text-gray-400">Total Clicks</p>
                    <p id="overviewTotalClicks" class="text-xl font-bold text-white mt-1">0</p>
                </div>
                
                <div class="p-4 bg-yellow-900/50 border-l-4 border-yellow-500 rounded-lg">
                    <p class="text-sm font-medium text-gray-400">Ref ID</p>
                    <p id="overviewRefId" class="text-xl font-bold text-white mt-1">Loading...</p>
                </div>
                <div class="p-4 bg-blue-900/50 border-l-4 border-blue-500 rounded-lg">
                    <p class="text-sm font-medium text-gray-400">Total Tickets (Split + Spin)</p>
                    <p id="overviewTotalTickets" class="text-xl font-bold text-white mt-1">0</p>
                </div>
                <div class="p-4 bg-green-900/50 border-l-4 border-green-500 rounded-lg">
                    <p class="text-sm font-medium text-gray-400">Total Sales Amount</p>
                    <p id="overviewTotalAmount" class="text-xl font-bold text-white mt-1">$0.00</p>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <nav class="flex space-x-4 mb-6 border-b border-gray-700">
            <button data-tab="referrers" class="tab-button py-3 px-4 text-gray-400 hover:text-white transition-colors hidden">Referrers</button>
            <button data-tab="raffle" class="tab-button py-3 px-4 text-gray-400 hover:text-white transition-colors">Split The Pot Sales</button>
            <button data-tab="rolex" class="tab-button py-3 px-4 text-gray-400 hover:text-white transition-colors hidden">Spin The Wheel Sales</button>
            <button data-tab="donations" class="tab-button py-3 px-4 text-gray-400 hover:text-white transition-colors hidden">Donations</button>
            <button data-tab="users" class="tab-button py-3 px-4 text-gray-400 hover:text-white transition-colors hidden">User Management</button>
            <button data-tab="tools" class="tab-button py-3 px-4 text-gray-400 hover:text-white transition-colors hidden">Admin Tools</button>
        </nav>

        <!-- Tab Content Containers -->
        <div id="tab-content" class="space-y-6">
        
            <!-- NEW: User Management Tab (Super Admin Only) -->
            <div id="tab-users" class="tab-pane hidden">
                <div class="dashboard-card p-4">
                    <h3 class="text-xl font-semibold mb-3 text-white">All Firebase Users</h3>
                    
                    <!-- Controls -->
                    <div class="flex flex-col sm:flex-row gap-4 mb-4 items-center">
                        <input type="text" id="userSearchInput" placeholder="Search by Name, Email, or UID..." class="w-full sm:w-1/3 p-2 pl-3 border border-gray-600 rounded-lg focus:ring-red-500 focus:border-red-500 bg-gray-700 text-white">
                        <div class="flex-grow"></div>
                        <div class="flex items-center space-x-3">
                            <span id="usersSelectedCount" class="text-sm font-medium text-gray-400">0 selected</span>
                            <button id="openBatchResetModalButton" class="px-4 py-2 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 transition-colors disabled:opacity-50" disabled>
                                Batch Reset Passwords
                            </button>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="data-table w-full whitespace-nowrap">
                            <thead>
                                <tr>
                                    <th class="w-12 text-center">
                                        <input type="checkbox" id="selectAllUsers" class="rounded text-red-500 focus:ring-red-500 bg-gray-700 border-gray-600">
                                    </th>
                                    <th class="user-sort-header cursor-pointer" data-sort-key="displayName" data-table="users">Name</th>
                                    <th class="user-sort-header cursor-pointer" data-sort-key="email" data-table="users">Email</th>
                                    <th>UID</th>
                                    <th class="user-sort-header cursor-pointer" data-sort-key="createdAt" data-table="users">Created</th>
                                    <th>Roles</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <tr><td colspan="7" class="text-center py-4 text-gray-400">Loading user list...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Referrers Tab Content (Super Admin Only) -->
            <div id="tab-referrers" class="tab-pane hidden">
                <div class="dashboard-card p-4">
                    <h3 class="text-xl font-semibold mb-3 text-white">All Referrers (SA Only)</h3>
                    
                    <!-- Search and Sort Controls -->
                    <div class="flex flex-col sm:flex-row gap-4 mb-4">
                        <!-- Search Input -->
                        <div class="relative flex-grow">
                            <input type="text" id="referrerSearchInput" placeholder="Search by Name, ID, or Email..." class="w-full p-2 pl-10 border border-gray-600 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 bg-gray-700 text-white">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.197 5.197a7.5 7.5 0 0010.607 10.607z" /></svg>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="data-table w-full whitespace-nowrap">
                            <thead>
                                <tr>
                                    <th class="referrer-sort-header cursor-pointer group hover:bg-gray-700" data-sort-key="name">
                                        <div class="flex items-center justify-between">Name
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 ml-1 hidden text-yellow-500"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /></svg>
                                        </div>
                                    </th>
                                    <th class="referrer-sort-header cursor-pointer group hover:bg-gray-700" data-sort-key="refId">
                                        <div class="flex items-center justify-between">Ref ID
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 ml-1 hidden text-yellow-500"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /></svg>
                                        </div>
                                    </th>
                                    <th>Email</th>
                                    <th class="referrer-sort-header cursor-pointer group hover:bg-gray-700 text-right" data-sort-key="raffleTickets">
                                        <div class="flex items-center justify-end">Split Pot Tickets
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 ml-1 hidden text-yellow-500"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /></svg>
                                        </div>
                                    </th>
                                    <th class="referrer-sort-header cursor-pointer group hover:bg-gray-700 text-right" data-sort-key="rolexTickets">
                                        <div class="flex items-center justify-end">Spin Wheel Tickets
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 ml-1 hidden text-yellow-500"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /></svg>
                                        </div>
                                    </th>
                                    <th class="referrer-sort-header cursor-pointer group hover:bg-gray-700 text-right" data-sort-key="combinedTotalAmount">
                                        <div class="flex items-center justify-end">Total Amount
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 ml-1 hidden text-yellow-500"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /></svg>
                                        </div>
                                    </th>
                                    <th>Goal</th>
                                    <th class="referrer-sort-header cursor-pointer group hover:bg-gray-700 text-right" data-sort-key="clickCount">
                                        <div class="flex items-center justify-end">Clicks
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 ml-1 hidden text-yellow-500"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /></svg>
                                        </div>
                                    </th>
                                    <th class="text-center">Action</th> <!-- NEW ACTION COLUMN -->
                                </tr>
                            </thead>
                            <tbody id="referrersTableBody">
                                <tr><td colspan="9" class="text-center py-4 text-gray-400">Loading referrer data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Split The Pot Sales Tab Content -->
            <div id="tab-raffle" class="tab-pane hidden">
                <div class="dashboard-card p-4 overflow-x-auto">
                    <!-- Filter and Header Controls -->
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-xl font-semibold text-white" id="raffleSalesHeader">Split The Pot Sales</h3>
                        <!-- FILTER DROPDOWN (Hidden for non-SA Referrers) -->
                        <div id="raffleFilterControls" class="flex items-center space-x-2">
                            <label for="raffleFilter" class="text-sm font-medium text-gray-400">Filter:</label>
                            <select id="raffleFilter" class="p-2 border border-gray-600 rounded-lg text-sm focus:ring-yellow-500 focus:border-yellow-500 bg-gray-700 text-white">
                                <option value="all">All Sales</option>
                                <option value="assigned">Assigned</option>
                                <option value="unassigned">Unassigned</option>
                            </select>
                        </div>
                    </div>

                    <table class="data-table w-full whitespace-nowrap">
                        <thead>
                            <tr>
                                <th class="sort-header" data-table="raffle" data-sort-key="timestamp">Date <span class="sort-icon ml-1"></span></th>
                                <th class="sort-header" data-table="raffle" data-sort-key="fullName">Full Name <span class="sort-icon ml-1"></span></th>
                                <th>Phone/Email</th>
                                <th class="sort-header" data-table="raffle" data-sort-key="ticketCount">Tickets <span class="sort-icon ml-1"></span></th>
                                <th class="sort-header text-right" data-table="raffle" data-sort-key="amountPaid">Amount Paid <span class="sort-icon ml-1"></span></th>
                                <th class="sort-header" data-table="raffle" data-sort-key="referrerRefId">Referrer <span class="sort-icon ml-1"></span></th>
                                <th>Source</th>
                                <th id="raffleSalesActionHeader" class="hidden">Action</th> <!-- Added for Edit button -->
                            </tr>
                        </thead>
                        <tbody id="raffleTableBody">
                            <tr><td colspan="7" class="text-center py-4 text-gray-400">Loading raffle sales data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Spin The Wheel Sales Tab Content (Super Admin Only) -->
            <div id="tab-rolex" class="tab-pane hidden">
                <div class="dashboard-card p-4 overflow-x-auto">
                    <!-- Filter and Header Controls -->
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-xl font-semibold text-white" id="rolexSalesHeader">Spin The Wheel Sales (SA Only)</h3>
                        <!-- NEW FILTER DROPDOWN -->
                        <div class="flex items-center space-x-2">
                            <label for="rolexFilter" class="text-sm font-medium text-gray-400">Filter:</label>
                            <select id="rolexFilter" class="p-2 border border-gray-600 rounded-lg text-sm focus:ring-purple-500 focus:border-purple-500 bg-gray-700 text-white">
                                <option value="all">All Tickets</option>
                                <option value="assigned">Assigned</option>
                                <option value="unassigned">Unassigned</option>
                            </select>
                        </div>
                    </div>

                    <table class="data-table w-full whitespace-nowrap">
                        <thead>
                            <tr>
                                <th class="sort-header" data-table="rolex" data-sort-key="timestamp">Date <span class="sort-icon ml-1"></span></th>
                                <th class="sort-header" data-table="rolex" data-sort-key="id">Ticket # <span class="sort-icon ml-1"></span></th>
                                <th class="sort-header" data-table="rolex" data-sort-key="name">Full Name <span class="sort-icon ml-1"></span></th>
                                <th>Email</th>
                                <th>Status</th>
                                <th class="sort-header text-right" data-table="rolex" data-sort-key="amountPaid">Amount Paid <span class="sort-icon ml-1"></span></th>
                                <th class="sort-header" data-table="rolex" data-sort-key="referrerRefId">Referrer <span class="sort-icon ml-1"></span></th>
                            </tr>
                        </thead>
                        <tbody id="rolexTableBody">
                            <tr><td colspan="7" class="text-center py-4 text-gray-400">No Spin The Wheel sales found.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Donations Tab Content (Super Admin Only) -->
            <div id="tab-donations" class="tab-pane hidden">
                <div class="dashboard-card p-4 overflow-x-auto">
                    <h3 class="text-xl font-semibold mb-3 text-white">All Donations (SA Only)</h3>
                    <table class="data-table w-full whitespace-nowrap">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th class="text-right">Amount</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="donationsTableBody">
                            <tr><td colspan="6" class="text-center py-4 text-gray-400">No donations found.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Admin Tools Tab Content (Super Admin Only) -->
            <div id="tab-tools" class="tab-pane hidden">
                <div class="dashboard-card p-6 space-y-4">
                    <h3 class="text-2xl font-bold text-white">System Tools (SA Only)</h3>
                    
                    <!-- Reserved Ticket Cleanup -->
                    <div class="border p-4 rounded-lg bg-red-900/50 border-red-700">
                        <h4 class="font-semibold text-lg text-red-400 mb-2">Reserved Ticket Cleanup (Spin The Wheel)</h4>
                        <div id="reservedTicketInfo" class="text-sm text-gray-300 mb-3">Loading counts...</div>
                        <button id="deleteExpiredTicketsButton" class="px-4 py-2 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition-colors disabled:opacity-50">
                            Manually Run Cleanup
                        </button>
                    </div>

                    <!-- Recalculate Totals -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        
                        <!-- NEW: Recalculate ALL Referrer Totals (The requested feature) -->
                        <div id="recalculateAllTotalsCard" class="border p-4 rounded-lg bg-red-900/50 border-red-700">
                            <h4 class="font-semibold text-lg text-red-400 mb-2">Recalculate ALL Referrer Totals</h4>
                            <p class="text-sm text-gray-300 mb-3">Rebuilds all ticket counts (Split/Spin) and combined sales amount for **every** referrer from all sales data.</p>
                            <button id="recalculateAllReferrerTotalsButton" class="px-4 py-2 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition-colors disabled:opacity-50">
                                Rebuild All Totals
                            </button>
                        </div>
                        
                        <!-- Recalculate Split The Pot Totals (Original) -->
                        <div id="recalculateRaffleTotalsCard" class="border p-4 rounded-lg bg-indigo-900/50 border-indigo-700">
                            <h4 class="font-semibold text-lg text-indigo-400 mb-2">Recalculate Split The Pot Totals (Global)</h4>
                            <p class="text-sm text-gray-300 mb-3">Resets and sums all Split the Pot entries to update **Global** <code>totalTickets</code> (Split Count) and <code>totalAmount</code> (Split $).</p>
                            <button id="recalculateTotalsButton" class="px-4 py-2 bg-indigo-500 text-white font-semibold rounded-lg hover:bg-indigo-600 transition-colors disabled:opacity-50">
                                Recalculate Global Pot
                            </button>
                        </div>

                        <!-- Recalculate Spin The Wheel Totals (NEW) -->
                        <div id="recalculateRolexTotalsCard" class="border p-4 rounded-lg bg-purple-900/50 border-purple-700">
                            <h4 class="font-semibold text-lg text-purple-400 mb-2">Recalculate Spin The Wheel Totals (Global)</h4>
                            <p class="text-sm text-gray-300 mb-3">Resets and sums all Spin tickets to update **Global** <code>rolexTicketsTotal</code> (Spin Count) and the combined <code>totalAmount</code> ($).</p>
                            <button id="recalculateRolexTotalsButton" class="px-4 py-2 bg-purple-500 text-white font-semibold rounded-lg hover:bg-purple-600 transition-colors disabled:opacity-50">
                                Recalculate Global Wheel
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <p id="authErrorDisplay" class="text-red-400 text-center mt-8 hidden">
            Authentication Error: You must sign in with a valid Admin, Super Admin, or Referrer account.
        </p>
    </div>
    
    <!-- Login Modal -->
    <div id="loginModalOverlay" class="fixed inset-0 z-50 modal-overlay flex items-center justify-center p-4">
        <div class="bg-gray-800 p-8 rounded-lg shadow-2xl w-full max-w-sm">
            <h2 class="text-3xl font-bold text-white mb-6 text-center">Admin Login</h2>
            <form id="loginForm" class="space-y-4">
                <div>
                    <input type="email" id="loginEmail" placeholder="Email" class="w-full p-3 border border-gray-600 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 bg-gray-700 text-white" required>
                </div>
                <div>
                    <input type="password" id="loginPassword" placeholder="Password" class="w-full p-3 border border-gray-600 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 bg-gray-700 text-white" required>
                </div>
                <button type="submit" id="loginButton" class="w-full py-3 text-black bg-yellow-500 rounded-lg font-semibold hover:bg-yellow-600 transition-colors">Sign In</button>
            </form>
            <p id="loginError" class="text-red-400 text-sm mt-3 text-center hidden"></p>
        </div>
    </div>


    <script type="module">
        // Import the modular functions you need from the SDKs using CDN paths
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInWithEmailAndPassword, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { 
            getFirestore, 
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        import { 
            getFunctions, 
            httpsCallable 
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-functions.js";

        // Global variables for Firebase services
        let app;
        let auth;
        let functions;
        let db;
        let isSuperAdmin = false;
        let isReferrer = false;
        let isLoggedInAdmin = false; 

        // --- GLOBAL STATE ---
        let allAuthUsers = []; // New array to hold all users from Firebase Auth
        let filteredAuthUsers = [];
        let selectedUserUids = new Set(); // New Set for multi-select UIDs
        let allAssignmentRaffleSales = []; 
        let filteredRaffleSales = []; 
        let selectedRaffleSaleIds = new Set(); 
        let targetRaffleRefId = null; 
        let targetRaffleRefName = null; 
        
        let allAssignmentRolexSales = [];
        let filteredRolexSales = [];
        let selectedRolexSaleIds = new Set();
        let targetRolexRefId = null;
        let targetRolexRefName = null;
        
        // Unified state for filtering sales tables by specific referrer (SA only)
        let activeRefIdFilter = null;
        let activeRefNameFilter = null;

        // State for sorting and filtering the sales tables
        let raffleSortConfig = { key: 'timestamp', direction: 'desc' };
        let raffleFilter = 'all'; // 'all', 'assigned', 'unassigned'

        let rolexSortConfig = { key: 'timestamp', direction: 'desc' };
        let rolexFilter = 'all'; // 'all', 'assigned', 'unassigned'
        
        // State for sorting the Referrers table
        let referrerSortConfig = { key: 'combinedTotalAmount', direction: 'desc' };
        let userSortConfig = { key: 'createdAt', direction: 'desc' }; // Default sort for users
        let searchTerm = '';
        let userSearchTerm = '';
        let currentTab = ''; // Tracks the currently active tab

        // ---------------------------------------------

        // Configuration and App ID (MUST be present in Canvas environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
            apiKey: "AIzaSyAT539nr_s2OxHPTAmkxwMpaWt-FiDTgQs",
            authDomain: "yderaffle.firebaseapp.com",
            projectId: "yderaffle",
            storageBucket: "yderaffle.firebasestorage.app",
            messagingSenderId: "967768309102",
            appId: "1:967768309102:web:c89d61a747e8cb941f557f"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- Utility Functions ---

        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 2 }).format(amount);
        };

        /**
         * Parses a timestamp (can be a Date, string, Firestore Timestamp object from client or server-serialized)
         * and formats it into a human-readable string.
         */
        const formatDate = (timestamp) => {
            if (!timestamp) return 'N/A';
            
            let date;
            
            if (typeof timestamp === 'object') {
                // Check for standard Firestore Timestamp object methods
                if (timestamp.toDate && typeof timestamp.toDate === 'function') {
                    date = timestamp.toDate();
                } else {
                    // Check for server-serialized raw seconds/nanoseconds (common from callable functions)
                    const seconds = timestamp.seconds || timestamp._seconds;
                    if (typeof seconds === 'number') {
                        date = new Date(seconds * 1000);
                    } else {
                        // Fallback: try converting the object itself (if it contains an ISO string, etc.)
                        date = new Date(timestamp);
                    }
                }
            } else {
                // Primitive value (string, number)
                date = new Date(timestamp);
            }

            if (isNaN(date.getTime())) {
                return 'Invalid Date';
            }

            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        };
        
        /**
         * Safely converts a value (Firebase Timestamp, Date object, string, or number) to milliseconds.
         */
        const getTimestampValue = (val) => {
            if (!val) return 0;
            
            let seconds = val.seconds || val._seconds;

            if (val.toDate && typeof val.toDate === 'function') {
                // Client SDK Timestamp
                return val.toDate().getTime();
            } else if (typeof seconds === 'number') {
                // Server-serialized Timestamp
                return seconds * 1000;
            } else {
                // Handle Date object or parsable value (string/number)
                let date = new Date(val);
                if (isNaN(date.getTime())) {
                    return 0;
                }
                return date.getTime();
            }
        };

        const showGlobalLoading = (message = "Loading dashboard data...") => {
            document.getElementById('globalSpinnerText').textContent = message;
            document.getElementById('globalLoadingOverlay').classList.remove('hidden');
        };
        const hideGlobalLoading = () => {
            document.getElementById('globalLoadingOverlay').classList.add('hidden');
        };
        
        // Redefine to avoid native confirm() and alert()
        const hideCustomPopup = () => {
            document.getElementById('customPopup').classList.remove('scale-100');
            setTimeout(() => { document.getElementById('customPopupOverlay').classList.add('hidden'); }, 300);
        };

        const showCustomPopup = (title, message, isConfirm = false) => {
            document.getElementById('popupTitle').textContent = title;
            document.getElementById('popupMessage').textContent = message;
            const closeBtn = document.getElementById('popupCloseButton');
            
            closeBtn.textContent = 'OK'; 
            closeBtn.onclick = hideCustomPopup;

            document.getElementById('customPopupOverlay').classList.remove('hidden');
            setTimeout(() => { document.getElementById('customPopup').classList.add('scale-100'); }, 10);
        };
        window.showCustomPopup = showCustomPopup; // Make available globally for handlers
        
        // Copy to clipboard function
        const copyToClipboard = (text, message = 'Link copied!') => {
            navigator.clipboard.writeText(text).then(() => {
                showCustomPopup('Success', message);
            }, (err) => {
                console.error('Could not copy text: ', err);
                try {
                    const tempInput = document.createElement('input');
                    tempInput.value = text;
                    document.body.appendChild(tempInput);
                    document.execCommand('copy');
                    document.body.removeChild(tempInput);
                    showCustomPopup('Success', message);
                } catch (e) {
                    showCustomPopup('Error', 'Failed to copy link. Please copy it manually.');
                }
            });
        };
        
        const getRefIdFromUrl = () => {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('ref');
        };

        const trackRefClick = async (refId) => {
            try {
                const trackRefLinkClickCallable = httpsCallable(functions, 'trackRefLinkClick');
                await trackRefLinkClickCallable({ refId }); 
            } catch (error) {
                console.error(`Failed to track click for ${refId}:`, error);
            }
        };

        
        // --- Client-Side Sorting and Filtering Logic ---
        
        const sortEntries = (data, sortConfig) => {
            // 1. Sort
            if (sortConfig.key) {
                data.sort((a, b) => {
                    let aVal = a[sortConfig.key];
                    let bVal = b[sortConfig.key];
                    
                    if (sortConfig.key === 'name' || sortConfig.key === 'fullName' || sortConfig.key === 'referrerRefId' || sortConfig.key === 'id' || sortConfig.key === 'email' || sortConfig.key === 'displayName') {
                        // String comparison
                        aVal = String(aVal || '').toLowerCase();
                        bVal = String(bVal || '').toLowerCase();
                        if (aVal < bVal) return sortConfig.direction === 'asc' ? -1 : 1;
                        if (aVal > bVal) return sortConfig.direction === 'asc' ? 1 : -1;
                        return 0;
                    } else if (sortConfig.key === 'timestamp' || sortConfig.key === 'createdAt' || sortConfig.key === 'lastSignInTime') {
                        // Date comparison
                        const aTime = getTimestampValue(aVal);
                        const bTime = getTimestampValue(bVal);
                        return sortConfig.direction === 'asc' ? aTime - bTime : bTime - aTime;
                    } 
                    else {
                        // Numeric comparison
                        aVal = aVal || 0;
                        bVal = bVal || 0;
                        if (aVal < bVal) return sortConfig.direction === 'asc' ? -1 : 1;
                        if (aVal > bVal) return sortConfig.direction === 'asc' ? 1 : -1;
                        return 0;
                    }
                });
            }
            return data;
        };

        const filterReferrers = (data) => {
            let filtered = data.filter(r => {
                const searchLower = searchTerm.toLowerCase();
                return r.name.toLowerCase().includes(searchLower) ||
                       (r.refId || '').toLowerCase().includes(searchLower) ||
                       (r.email || '').toLowerCase().includes(searchLower);
            });
            return sortEntries(filtered, referrerSortConfig);
        };

        const filterAuthUsers = (data) => {
            let filtered = data.filter(u => {
                const searchLower = userSearchTerm.toLowerCase();
                return (u.displayName || '').toLowerCase().includes(searchLower) ||
                       (u.email || '').toLowerCase().includes(searchLower) ||
                       (u.uid || '').toLowerCase().includes(searchLower);
            });
            return sortEntries(filtered, userSortConfig);
        };
        
        const filterSalesEntries = (data, filterType) => {
            let filtered = [...data];
            
            if (filterType === 'assigned') {
                filtered = filtered.filter(e => e.referrerRefId && e.referrerRefId !== null && e.referrerRefId !== "");
            } else if (filterType === 'unassigned') {
                filtered = filtered.filter(e => !e.referrerRefId || e.referrerRefId === null || e.referrerRefId === "");
            }
            return filtered;
        }


        const calculateReferrerMetrics = (data) => {
            const referrerMap = new Map();
            let currentUserRefId = data.userData.refId;

            data.referrers.forEach(r => {
                // FIX: Explicitly parse ticket and amount values to ensure they are treated as numbers
                const raffleTickets = parseInt(r.totalTickets) || 0; 
                const rolexTickets = parseInt(r.rolexTicketsTotal) || 0; 
                
                // Use the server-provided amount directly (should be the correct combined revenue)
                let combinedTotalAmount = parseFloat(r.totalAmount) || 0; 

                // FIX: Remove the faulty estimation logic from the previous step.
                // We rely on the server's aggregated 'totalAmount' now, which is correct for the list.

                const totalTickets = raffleTickets + rolexTickets;

                referrerMap.set(r.refId, {
                    ...r,
                    raffleTickets: raffleTickets,
                    rolexTickets: rolexTickets,
                    // Use the server's authoritative combined amount
                    combinedTotalAmount: combinedTotalAmount, 
                    totalTickets: totalTickets, 
                    clickCount: parseInt(r.clickCount) || 0
                });
            });

            data.referrers = Array.from(referrerMap.values());
            
            // FIX: Ensure data.userData gets the fully calculated/parsed metrics from the map.
            // This is the key fix to update the overview card.
            if (currentUserRefId && referrerMap.has(currentUserRefId)) {
                data.userData = referrerMap.get(currentUserRefId);
            }
            
            return data;
        };


        // --- Core Data Fetching and UI Logic ---

        let dashboardData = {
            referrers: [],
            raffleEntries: [],
            rolexEntries: [],
            donationEntries: [],
            userData: {}
        };

        const renderTables = () => {
            if (isSuperAdmin) {
                renderAuthUsersTable(allAuthUsers); // New User Management Table
                renderReferrersTable(dashboardData.referrers);
                renderRolexTable(dashboardData.rolexEntries); 
                renderDonationsTable(dashboardData.donationEntries);
            }
            // Render Raffle table is the base view for all authorized users
            renderRaffleTable(dashboardData.raffleEntries);
            
            if (isReferrer && !isSuperAdmin) {
                // If a non-SA referrer logs in, show their personal rolex data
                // This is hidden by default and only for referrers who have access to their own referral card
                // The Rolex tab is hidden below, but if we wanted them to see their rolex sales here, we'd add logic.
                // For now, only Super Admin sees the Rolex Sales tab, so we skip rendering it for the base case.
            }
        };

        const fetchAllUsers = async () => {
            if (!isSuperAdmin) return;
            showGlobalLoading("Fetching all users...");
            try {
                const getAllAuthUsersCallable = httpsCallable(functions, 'getAllAuthUsers');
                const response = await getAllAuthUsersCallable({});
                allAuthUsers = response.data.users;
                renderAuthUsersTable(allAuthUsers);
            } catch (error) {
                console.error("Error fetching all users:", error);
                showCustomPopup('User Fetch Error', `Failed to load user list: ${error.message}`);
            } finally {
                // Keep the global spinner open until all dashboard data is loaded later
            }
        }

        const fetchDashboardData = async () => {
            showGlobalLoading("Fetching dashboard data...");
            try {
                const getAdminDashboardDataCallable = httpsCallable(functions, 'getAdminDashboardData');
                const response = await getAdminDashboardDataCallable({});
                
                dashboardData = response.data;
                isSuperAdmin = dashboardData.isSuperAdmin;
                isReferrer = dashboardData.isReferrer;
                isLoggedInAdmin = dashboardData.isSuperAdmin || dashboardData.isReferrer || (auth.currentUser && auth.currentUser.customClaims.admin);

                // Fetch all users ONLY for Super Admin
                if (isSuperAdmin) {
                    // This call will set allAuthUsers and call renderAuthUsersTable
                    await fetchAllUsers();
                }

                dashboardData = calculateReferrerMetrics(dashboardData); 

                let roleText = 'Admin';
                if (isSuperAdmin) roleText = 'Super Admin';
                else if (isReferrer) roleText = 'Referrer';
                document.getElementById('userRoleDisplay').textContent = `(${roleText})`;
                
                const referrerTab = document.querySelector('[data-tab="referrers"]');
                const donationTab = document.querySelector('[data-tab="donations"]');
                const toolsTab = document.querySelector('[data-tab="tools"]');
                const rolexTab = document.querySelector('[data-tab="rolex"]');
                const usersTab = document.querySelector('[data-tab="users"]');
                const raffleTab = document.querySelector('[data-tab="raffle"]');
                const addManualSaleButton = document.getElementById('addManualSaleButton');
                const overviewCard = document.getElementById('referrerOverview');
                const exportButton = document.getElementById('exportDataButton');
                const raffleFilterControls = document.getElementById('raffleFilterControls');

                // --- Access Control Logic ---
                
                // 1. Hide all SA-only sections initially
                referrerTab.classList.add('hidden');
                donationTab.classList.add('hidden');
                toolsTab.classList.add('hidden');
                rolexTab.classList.add('hidden'); 
                usersTab.classList.add('hidden'); 
                addManualSaleButton.classList.add('hidden');
                overviewCard.classList.add('hidden');
                exportButton.classList.add('hidden');
                raffleTab.classList.add('hidden'); // Start hidden, only show if authenticated

                
                if (isSuperAdmin) {
                    // Super Admin sees everything
                    referrerTab.classList.remove('hidden');
                    donationTab.classList.remove('hidden');
                    toolsTab.classList.remove('hidden');
                    rolexTab.classList.remove('hidden'); 
                    usersTab.classList.remove('hidden'); 
                    addManualSaleButton.classList.remove('hidden');
                    exportButton.classList.remove('hidden');
                    overviewCard.classList.remove('hidden');
                    raffleTab.classList.remove('hidden'); // Show Raffle Tab

                    currentTab = currentTab || 'referrers'; // Set referrers tab as default for SA

                } else if (isReferrer) {
                    // Regular Referrer sees their overview and Split The Pot Sales (filtered internally)
                    overviewCard.classList.remove('hidden');
                    raffleTab.classList.remove('hidden'); // Show Raffle Tab
                    raffleFilterControls.classList.add('hidden'); // Hide filter dropdown for non-SA Referrers
                    
                    currentTab = currentTab || 'raffle';
                    
                } else if (isLoggedInAdmin) { 
                    // General Admin (non-referrer, non-super) sees only the Raffle Tab (All Sales)
                    raffleTab.classList.remove('hidden');
                    raffleFilterControls.classList.remove('hidden'); // Show filter controls for general admins
                    currentTab = currentTab || 'raffle';
                }

                // --- Overview Card Population (Visible to SA and Referrers) ---
                if (isReferrer || isSuperAdmin) {
                    const refId = dashboardData.userData.refId || 'N/A';
                    
                    // FIX: Find the authoritative entry in the processed referrers list
                    let currentSelfData = dashboardData.userData;
                    const authoritativeData = dashboardData.referrers.find(r => r.refId === refId);
                    if (authoritativeData) {
                        currentSelfData = authoritativeData;
                    }
                    
                    // These values should now be correctly calculated and sourced from the authoritative list entry
                    const finalRefId = currentSelfData.refId || 'N/A';
                    const finalTotalTickets = currentSelfData.totalTickets || 0; // Should be 40 (39+1)
                    const finalTotalAmount = currentSelfData.combinedTotalAmount || 0; // Should be 847
                    const finalClicks = currentSelfData.clickCount || 0;
                    
                    document.getElementById('overviewRefId').textContent = finalRefId;
                    
                    document.getElementById('overviewTotalClicks').textContent = finalClicks.toLocaleString(); 
                    
                    document.getElementById('overviewTotalTickets').textContent = finalTotalTickets.toLocaleString();
                    document.getElementById('overviewTotalAmount').textContent = formatCurrency(finalTotalAmount); 

                    const referralLinkElement = document.getElementById('referralLink');
                    const link = `ydeseniors.com/?ref=${finalRefId}`;
                    referralLinkElement.textContent = link;
                    document.getElementById('referrerLinkContainer').classList.remove('hidden');

                    document.getElementById('copyLinkButton').onclick = () => {
                        copyToClipboard(`https://${link}`, 'Referral link copied!');
                    };
                } else {
                    document.getElementById('referrerLinkContainer').classList.add('hidden');
                }
                
                renderTables();
                updateSortIndicators('referrer', referrerSortConfig); 
                updateSortIndicators('users', userSortConfig);
                
                if (isSuperAdmin || isLoggedInAdmin) {
                    await updateReservedTicketCounts();
                }
                
                hideGlobalLoading();
                switchTab(currentTab || 'raffle'); 

            } catch (error) {
                console.error("Error fetching dashboard data:", error);
                hideGlobalLoading();
                if (error.code === 'permission-denied') {
                    document.getElementById('authErrorDisplay').textContent = "Permission Denied: Your account is not authorized as Admin, Super Admin, or Referrer.";
                    document.getElementById('authErrorDisplay').classList.remove('hidden');
                    document.getElementById('dashboardContainer').classList.add('hidden');
                } else {
                    showCustomPopup('Data Fetch Error', `Failed to load dashboard data: ${error.message}. Please check logs.`);
                }
            }
        };
        
        // --- Sorting Indicator Logic ---
        const updateSortIndicators = (table, config) => {
            // Find all headers associated with the table
            document.querySelectorAll(`.sort-header[data-table="${table}"], .referrer-sort-header[data-sort-key], .user-sort-header[data-sort-key]`).forEach(header => {
                // Determine if this header belongs to the current table context based on class or attribute
                const tableContext = header.dataset.table || (header.classList.contains('referrer-sort-header') ? 'referrer' : (header.classList.contains('user-sort-header') ? 'users' : ''));
                if (tableContext === table) {
                    header.classList.remove('active', 'text-yellow-400', 'text-purple-400', 'text-red-400', 'font-semibold');
                    
                    // Specific handling for referrer table header icons (using the nested SVG)
                    if (header.classList.contains('referrer-sort-header')) {
                        header.querySelectorAll('svg').forEach(svg => svg.classList.add('hidden'));
                    }
                    
                    // Specific handling for non-referrer/user sales table icons (using the inner span)
                    const icon = header.querySelector('.sort-icon');
                    if (icon) icon.classList.add('hidden');
                }
            });
            
            // Highlight the active header
            const activeHeader = document.querySelector(`[data-table="${table}"][data-sort-key="${config.key}"], .referrer-sort-header[data-sort-key="${config.key}"], .user-sort-header[data-sort-key="${config.key}"]`);
            if (activeHeader) {
                activeHeader.classList.add('active', 'font-semibold');

                // Determine color based on table type
                let colorClass = 'text-yellow-400'; // Default for raffle/referrer
                if (table === 'rolex') colorClass = 'text-purple-400';
                else if (table === 'users') colorClass = 'text-red-400';

                activeHeader.classList.add(colorClass);

                // Handle icon display
                if (activeHeader.classList.contains('referrer-sort-header')) {
                    // Handle nested SVG for referrer table
                    const svg = activeHeader.querySelector('svg');
                    if (svg) {
                        svg.classList.remove('hidden');
                        // Rotate SVG for direction
                        svg.style.transform = config.direction === 'asc' ? 'rotate(180deg)' : 'rotate(0deg)';
                    }
                } else {
                    // Handle inner span for sales tables
                    const icon = activeHeader.querySelector('.sort-icon');
                    if (icon) {
                        icon.classList.remove('hidden');
                        icon.innerHTML = config.direction === 'asc' ? '&#9650;' : '&#9660;'; // Up or Down Triangle
                    }
                }
            }
        };

        // --- Render Functions ---
        
        const renderAuthUsersTable = (users) => {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';
            
            filteredAuthUsers = filterAuthUsers(users);

            // 1. Reset Select All and count
            const selectAllCheckbox = document.getElementById('selectAllUsers');
            selectAllCheckbox.checked = false;
            selectedUserUids.clear();
            document.getElementById('usersSelectedCount').textContent = `0 selected`;
            document.getElementById('openBatchResetModalButton').disabled = true;

            if (filteredAuthUsers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-400">No users found matching search criteria.</td></tr>';
                return;
            }
            
            filteredAuthUsers.forEach(u => {
                const tr = document.createElement('tr');
                
                const isSelected = selectedUserUids.has(u.uid);
                
                const statusContent = u.disabled 
                    ? '<span class="text-xs font-medium px-2 py-1 rounded-full bg-red-900/50 text-red-400">DISABLED</span>'
                    : '<span class="text-xs font-medium px-2 py-1 rounded-full bg-green-900/50 text-green-400">ACTIVE</span>';

                const roles = [];
                if (u.isSuperAdmin) roles.push('SA');
                if (u.isReferrer) roles.push('Ref');
                if (u.isAdmin && !u.isSuperAdmin && !u.isReferrer) roles.push('Admin');
                if (roles.length === 0) roles.push('User');

                tr.innerHTML = `
                    <td class="text-center">
                        <input type="checkbox" data-uid="${u.uid}" class="user-select-checkbox rounded text-red-500 focus:ring-red-500 bg-gray-700 border-gray-600" ${isSelected ? 'checked' : ''}>
                    </td>
                    <td>${u.displayName}</td>
                    <td><span class="${u.emailVerified ? 'text-green-400' : 'text-orange-400'}" title="${u.emailVerified ? 'Verified' : 'Unverified'}">${u.email}</span></td>
                    <td class="font-mono text-xs text-gray-400 truncate max-w-[150px]">${u.uid}</td>
                    <td>${formatDate(u.createdAt)}</td>
                    <td>${roles.map(r => `<span class="text-xs font-medium px-2 py-1 rounded-full bg-gray-600 text-gray-300">${r}</span>`).join(' ')}</td>
                    <td>${statusContent}</td>
                `;
                tbody.appendChild(tr);
            });
            updateSortIndicators('users', userSortConfig);
        };
        
        const handleUserCheckboxChange = (e) => {
            const uid = e.target.dataset.uid;
            if (e.target.checked) {
                selectedUserUids.add(uid);
            } else {
                selectedUserUids.delete(uid);
            }
            
            // Update UI elements
            document.getElementById('usersSelectedCount').textContent = `${selectedUserUids.size} selected`;
            document.getElementById('openBatchResetModalButton').disabled = selectedUserUids.size === 0;

            const selectAllCheckbox = document.getElementById('selectAllUsers');
            if (selectedUserUids.size === filteredAuthUsers.length && filteredAuthUsers.length > 0) {
                selectAllCheckbox.checked = true;
            } else {
                selectAllCheckbox.checked = false;
            }
        };

        const handleUserSelectAllChange = (e) => {
            selectedUserUids.clear();
            const isChecked = e.target.checked;

            document.querySelectorAll('.user-select-checkbox').forEach(checkbox => {
                checkbox.checked = isChecked;
                const uid = checkbox.dataset.uid;
                if (isChecked) {
                    selectedUserUids.add(uid);
                }
            });

            document.getElementById('usersSelectedCount').textContent = `${selectedUserUids.size} selected`;
            document.getElementById('openBatchResetModalButton').disabled = selectedUserUids.size === 0;
        };

        const handleUserSearchChange = (e) => {
            userSearchTerm = e.target.value;
            renderAuthUsersTable(allAuthUsers);
        };
        
        const openBatchResetModal = () => {
            if (!isSuperAdmin) return;
            if (selectedUserUids.size === 0) {
                showCustomPopup('Selection Required', 'Please select at least one user to reset the password.');
                return;
            }
            document.getElementById('selectedUserCount').textContent = selectedUserUids.size;
            document.getElementById('batchResetForm').reset();
            document.getElementById('submitBatchReset').disabled = false;
            document.getElementById('batchResetModalOverlay').classList.remove('hidden');
        };

        const closeBatchResetModal = () => {
            document.getElementById('batchResetModalOverlay').classList.add('hidden');
        };

        const handleBatchResetSubmit = async (e) => {
            e.preventDefault();
            
            const newPassword = document.getElementById('batch-new-password').value;
            const uidsToReset = Array.from(selectedUserUids);

            if (newPassword.length < 6) {
                showCustomPopup('Invalid Password', 'The new password must be at least 6 characters long.');
                return;
            }

            closeBatchResetModal();
            showGlobalLoading(`Resetting passwords for ${uidsToReset.length} users...`);

            try {
                const adminResetMultiPasswordCallable = httpsCallable(functions, 'adminResetMultiPassword');
                const response = await adminResetMultiPasswordCallable({ uids: uidsToReset, newPassword });

                const { successfulResets, failedResets } = response.data;

                if (failedResets.length === 0) {
                    showCustomPopup('Batch Reset Complete', `Successfully reset ${successfulResets.length} password(s). All users must now use the new temporary password.`);
                } else {
                    showCustomPopup('Batch Reset Complete (With Errors)', 
                        `Successfully reset ${successfulResets.length} password(s). Failed to reset ${failedResets.length} user(s). Check console for failure details.`);
                }
                
                // Clear selection and refresh user list
                selectedUserUids.clear();
                await fetchDashboardData(); 

            } catch (error) {
                console.error("Batch Reset Failed:", error);
                showCustomPopup('Batch Reset Failed', `Error: ${error.message}`);
            } finally {
                hideGlobalLoading();
            }
        };


        const renderReferrersTable = (referrers) => {
            const tbody = document.getElementById('referrersTableBody');
            tbody.innerHTML = '';
            
            // Only Super Admins see this table content
            if (!isSuperAdmin) {
                 tbody.innerHTML = '<tr><td colspan="9" class="text-center py-4 text-gray-400">Permission Denied. Only Super Admins can view all referrers.</td></tr>';
                 return;
            }

            const sortedReferrers = filterReferrers(referrers);

            if (sortedReferrers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center py-4 text-gray-400">No referrers found matching search criteria.</td></tr>';
                return;
            }
            sortedReferrers.forEach(r => {
                const tr = document.createElement('tr');
                
                let nameCellContent = r.name;
                let actionCellContent = 'N/A';
                let upgradeButton = '';

                // Super Admin can see the action buttons and click to filter sales
                if (isSuperAdmin) {
                    // Update: Clicking the name now applies the combined filter and shows sales.
                    nameCellContent = `<span 
                                         class="text-white font-semibold cursor-pointer hover:underline" 
                                         data-action="view-referrer-sales" 
                                         data-refid="${r.refId}" 
                                         data-refname="${r.name}"
                                         >${r.name}</span>`;
                    
                    if (r.uid !== auth.currentUser?.uid) {
                        upgradeButton = `
                            <button class="px-2 py-1 text-xs bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 transition-colors mb-1"
                                             data-action="promote-sa"
                                             data-uid="${r.uid}"
                                             data-refid="${r.refId}"
                                             data-refname="${r.name}">Promote to SA</button>
                        `;
                    }
                    
                    actionCellContent = `
                        ${upgradeButton}
                        <button class="px-2 py-1 text-xs bg-purple-500 text-white font-semibold rounded-lg shadow-md hover:bg-purple-600 transition-colors mb-1"
                                             data-action="assign-rolex-tickets"
                                             data-refid="${r.refId}"
                                             data-refname="${r.name}">Assign Spin</button>
                        <button class="px-2 py-1 text-xs bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition-colors"
                                             data-action="assign-raffle-tickets"
                                             data-refid="${r.refId}"
                                             data-refname="${r.name}">Assign Raffle</button>
                    `;
                }

                tr.innerHTML = `
                    <td>${nameCellContent}</td>
                    <td><span class="font-mono text-xs px-2 py-1 bg-yellow-400/20 text-yellow-300 rounded">${r.refId}</span></td>
                    <td>${r.email}</td>
                    <td class="text-right">${(r.raffleTickets || 0).toLocaleString()}</td>
                    <td class="text-right">${(r.rolexTickets || 0).toLocaleString()}</td>
                    <td class="text-right font-semibold">${formatCurrency(r.combinedTotalAmount || 0)}</td>
                    <td class="text-right">${formatCurrency(r.goal || 0)}</td>
                    <td class="text-right font-bold text-purple-400">${(r.clickCount || 0).toLocaleString()}</td>
                    <td class="text-center flex flex-col items-center justify-center space-y-1">${actionCellContent}</td>
                `;
                tbody.appendChild(tr);
            });
            updateSortIndicators('referrer', referrerSortConfig);
        };

        const renderRaffleTable = (entries) => {
            const tbody = document.getElementById('raffleTableBody');
            const header = document.getElementById('raffleSalesHeader');
            const actionHeader = document.getElementById('raffleSalesActionHeader');
            const raffleFilterControls = document.getElementById('raffleFilterControls');
            tbody.innerHTML = '';
            
            // 1. Filter based on current filter state ('all', 'assigned', 'unassigned') and referrer filter
            let displayEntries = filterSalesEntries(entries, raffleFilter);

            // Apply automatic filter for non-Super Admin referrers.
            const currentRefId = dashboardData.userData.refId;
            
            // Determine header and filter visibility
            raffleFilterControls.classList.remove('hidden');

            if (isReferrer && !isSuperAdmin) {
                // Non-Super Admin Referrer: filter sales to only show their referred sales
                displayEntries = displayEntries.filter(e => e.referrerRefId === currentRefId);
                header.textContent = "Your Split The Pot Sales";
                activeRefIdFilter = null; // Clear manual filter if automatic filter is active
                raffleFilterControls.classList.add('hidden'); // Hide filter dropdown
                
            } else if (activeRefIdFilter) {
                // Super Admin manual filter is active
                header.textContent = `Split The Pot Sales for ${activeRefNameFilter}`;
                displayEntries = displayEntries.filter(e => e.referrerRefId === activeRefIdFilter);
                header.innerHTML += ` <button id="clearRaffleFilter" class="ml-4 px-2 py-1 text-sm text-white bg-red-500 rounded-lg hover:bg-red-600">Clear Filter</button>`;
                
            } else {
                // Super Admin or General Admin viewing all sales
                header.textContent = "All Split The Pot Sales";
            }

            // 2. Sort the display entries
            displayEntries = sortEntries(displayEntries, raffleSortConfig);

            // 3. Show/Hide action column header for SA
            if (isSuperAdmin) {
                actionHeader.classList.remove('hidden');
            } else {
                actionHeader.classList.add('hidden');
            }

            // 4. Render rows
            if (displayEntries.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${isSuperAdmin ? 8 : 7}" class="text-center py-4 text-gray-400">No Split The Pot sales found matching current criteria.</td></tr>`;
                return;
            }
            displayEntries.forEach(e => {
                const referrerInfo = e.referrerName ? `<span class="text-gray-300">${e.referrerName}</span> (<span class="font-mono text-xs px-1 bg-yellow-400/20 text-yellow-300 rounded">${e.referrerRefId}</span>)` : '<span class="text-red-400 font-medium">None</span>';
                const customerName = e.fullName || e.name || e.firstName || 'N/A';
                
                let actionCell = '';
                if (isSuperAdmin) {
                    actionCell = `
                        <button class="px-2 py-1 text-xs bg-yellow-500 text-black font-semibold rounded-lg hover:bg-yellow-600 transition-colors"
                            data-action="edit-sale"
                            data-entry-id="${e.id}">Edit</button>
                    `;
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${formatDate(e.timestamp)}</td>
                    <td>${customerName}</td>
                    <td>${e.phoneNumber || e.email || 'N/A'}</td>
                    <td>${(e.ticketCount || 0).toLocaleString()}</td>
                    <td class="text-right font-medium">${formatCurrency(e.amountPaid || 0)}</td>
                    <td>${referrerInfo}</td>
                    <td>${e.sourceApp || 'N/A'}</td>
                    ${isSuperAdmin ? `<td>${actionCell}</td>` : ''}
                `;
                tbody.appendChild(tr);
            });
            updateSortIndicators('raffle', raffleSortConfig);
        };

        const renderRolexTable = (entries) => {
            const tbody = document.getElementById('rolexTableBody');
            const header = document.getElementById('rolexSalesHeader');

            // 1. Filter based on current filter state
            let displayEntries = filterSalesEntries(entries, rolexFilter);
            
            // Apply direct referrer filter (Rolex must also be filtered by the active referrer if set)
            if (activeRefIdFilter) {
                displayEntries = displayEntries.filter(e => e.referrerRefId === activeRefIdFilter);
                header.textContent = `Spin The Wheel Sales for ${activeRefNameFilter}`;
                header.innerHTML += ` <button id="clearRolexFilter" class="ml-4 px-2 py-1 text-sm text-white bg-red-500 rounded-lg hover:bg-red-600">Clear Filter</button>`;
            } else if (!isSuperAdmin) {
                // Regular referrer view (they shouldn't see this tab anyway, but just in case, only show their own)
                // This logic is mostly redundant because the tab is hidden via fetchDashboardData, but good practice.
                const currentRefId = dashboardData.userData.refId;
                displayEntries = displayEntries.filter(e => e.referrerRefId === currentRefId);
                header.textContent = "Your Spin The Wheel Sales";
            } else {
                header.textContent = "Spin The Wheel Sales (SA Only)";
            }

            // 2. Sort the display entries
            displayEntries = sortEntries(displayEntries, rolexSortConfig);
            tbody.innerHTML = '';


            if (displayEntries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-400">No Spin The Wheel sales found matching current criteria.</td></tr>';
                return;
            }
            displayEntries.forEach(e => {
                const referrerInfo = e.referrerRefId ? `<span class="font-mono text-xs px-1 bg-yellow-400/20 text-yellow-300 rounded">${e.referrerRefId}</span>` : 'None';
                const statusClass = e.status === 'paid' ? 'bg-green-700/50 text-green-300' : 'bg-yellow-700/50 text-yellow-300';
                
                const customerName = e.fullName || e.name || e.firstName || 'N/A';
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${formatDate(e.timestamp)}</td>
                    <td class="font-bold">${e.id}</td>
                    <td>${customerName}</td>
                    <td>${e.email || 'N/A'}</td>
                    <td><span class="text-xs font-medium px-2 py-1 rounded-full ${statusClass}">${e.status.toUpperCase()}</span></td>
                    <td class="text-right font-medium">${formatCurrency(e.amountPaid || 0)}</td>
                    <td>${referrerInfo}</td>
                `;
                tbody.appendChild(tr);
            });
            updateSortIndicators('rolex', rolexSortConfig);
        };
        
        const renderDonationsTable = (entries) => {
            const tbody = document.getElementById('donationsTableBody');
            tbody.innerHTML = '';
            // Donations always sort by creation date descending
            const sortedEntries = entries.sort((a, b) => getTimestampValue(b.createdAt) - getTimestampValue(a.createdAt));

            if (entries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-400">No donations found.</td></tr>';
                return;
            }
            sortedEntries.forEach(e => {
                const customerName = e.fullName || e.name || 'N/A';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${formatDate(e.createdAt)}</td>
                    <td>${customerName}</td>
                    <td>${e.email || 'N/A'}</td>
                    <td>${e.phone || 'N/A'}</td>
                    <td class="text-right font-medium">${formatCurrency(e.amount || e.amountPaid || 0)}</td>
                    <td><span class="text-xs font-medium px-2 py-1 rounded-full bg-green-700/50 text-green-300">${(e.status || 'N/A').toUpperCase()}</span></td>
                `;
                tbody.appendChild(tr);
            });
        };

        const switchTab = (tabName) => {
            currentTab = tabName;
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.querySelector(`.tab-button[data-tab="${tabName}"]`);
            if (activeBtn) activeBtn.classList.add('active');

            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('hidden'));
            const activePane = document.getElementById(`tab-${tabName}`);
            if (activePane) activePane.classList.remove('hidden');

            // Re-render tables on tab switch in case a filter is active
            if (activeRefIdFilter) {
                renderRaffleTable(dashboardData.raffleEntries);
                renderRolexTable(dashboardData.rolexEntries);
            }
            // Ensure filter control visibility is respected if we land on raffle tab
            if (tabName === 'raffle') {
                 const raffleFilterControls = document.getElementById('raffleFilterControls');
                 if (isReferrer && !isSuperAdmin) {
                    raffleFilterControls.classList.add('hidden');
                 } else {
                    raffleFilterControls.classList.remove('hidden');
                 }
            }
        };

        // --- NEW: Refresh Feature ---
        const handleRefreshClick = async () => {
            if (activeRefIdFilter) {
                clearRefIdFilter(); 
            }
            await fetchDashboardData();
        };

        // --- Referrer Sales View Feature Functions (Combined Filter) ---
        
        const openReferrerSalesModal = (refId, refName) => {
            if (!isSuperAdmin) {
                showCustomPopup('Permission Denied', 'Only Super Admins can view filtered referrer sales.');
                return;
            }
            
            // Set the unified filter state
            activeRefIdFilter = refId;
            activeRefNameFilter = refName;
            
            // Reset the internal sales filter to 'all' so we see all sales types
            raffleFilter = 'all'; 
            document.getElementById('raffleFilter').value = 'all';

            // Re-render both sales tables (Raffle and Rolex) to apply the combined filter
            renderRaffleTable(dashboardData.raffleEntries); 
            renderRolexTable(dashboardData.rolexEntries); 
            
            switchTab('raffle'); // Switch to the Raffle tab, where the filter starts
        };
        
        const clearRefIdFilter = () => {
            activeRefIdFilter = null;
            activeRefNameFilter = null;
            
            // Restore the main filter setting and remove the clear button
            document.getElementById('raffleFilter').value = raffleFilter; 
            
            // Re-render both sales tables to clear filters
            renderRaffleTable(dashboardData.raffleEntries); 
            renderRolexTable(dashboardData.rolexEntries); 
        };
        
        // --- Edit Order Feature Functions ---
        
        const openEditSaleModal = (entryId) => {
            const sale = dashboardData.raffleEntries.find(e => e.id === entryId);
            if (!sale) {
                showCustomPopup('Error', 'Sale entry not found.');
                return;
            }

            document.getElementById('edit-sale-id').value = entryId;
            document.getElementById('edit-name').value = sale.fullName || sale.name || sale.firstName || '';
            document.getElementById('edit-email').value = sale.email || '';
            document.getElementById('edit-phone').value = sale.phoneNumber || '';
            document.getElementById('edit-tickets').value = sale.ticketCount || 0;
            document.getElementById('edit-amount').value = sale.amountPaid || 0;

            document.getElementById('editSaleModalOverlay').classList.remove('hidden');
        };

        const closeEditSaleModal = () => {
            document.getElementById('editSaleModalOverlay').classList.add('hidden');
        };

        const handleEditSaleSubmit = async (e) => {
            e.preventDefault();
            
            const entryId = document.getElementById('edit-sale-id').value;
            const updatedData = {
                fullName: document.getElementById('edit-name').value.trim(),
                email: document.getElementById('edit-email').value.trim(),
                phoneNumber: document.getElementById('edit-phone').value.trim(),
                ticketCount: parseInt(document.getElementById('edit-tickets').value.trim(), 10),
                amountPaid: parseFloat(document.getElementById('edit-amount').value.trim()),
            };

            closeEditSaleModal();
            showGlobalLoading(`Updating sale ${entryId}...`);

            try {
                const updateRaffleEntryCallable = httpsCallable(functions, 'updateRaffleEntry');
                const response = await updateRaffleEntryCallable({ entryId, updatedData });

                showCustomPopup('Success', response.data.message);
                await fetchDashboardData(); 

            } catch (error) {
                console.error("Error updating sale:", error);
                showCustomPopup('Update Failed', `Error: ${error.message}`);
            } finally {
                hideGlobalLoading();
            }
        };

        // --- Promote to Super Admin Logic (unchanged) ---

        const upgradeToSuperAdmin = async (uid) => {
            try {
                const setSuperAdminClaimCallable = httpsCallable(functions, 'setSuperAdminClaim'); 
                const response = await setSuperAdminClaimCallable({ uid });
                return response.data;
            } catch (error) {
                console.error("Error calling upgradeToSuperAdmin:", error);
                throw error;
            }
        }

        const openUpgradeAdminModal = (uid, name, refId) => {
            if (!isSuperAdmin) {
                showCustomPopup('Permission Denied', 'Only Super Admins can promote other users.');
                return;
            }
            
            document.getElementById('upgrade-referrer-uid').value = uid;
            document.getElementById('upgrade-referrer-name').textContent = name;
            document.getElementById('upgrade-referrer-refid').textContent = refId;

            document.getElementById('upgradeAdminModalOverlay').classList.remove('hidden');
        }

        const closeUpgradeAdminModal = () => {
            document.getElementById('upgradeAdminModalOverlay').classList.add('hidden');
        }

        const handleUpgradeAdmin = async () => {
            const uid = document.getElementById('upgrade-referrer-uid').value;
            const name = document.getElementById('upgrade-referrer-name').textContent;
            
            closeUpgradeAdminModal();
            showGlobalLoading(`Promoting ${name} to Super Admin...`);

            try {
                await upgradeToSuperAdmin(uid);
                
                showCustomPopup('Success', `${name} has been promoted to Super Admin. They must sign out and sign back in to see their new permissions.`);
                
                await fetchDashboardData(); 
                
            } catch (error) {
                console.error("Promotion Failed:", error);
                showCustomPopup('Promotion Failed', `Failed to promote ${name}. Error: ${error.message}. Ensure your backend function 'setSuperAdminClaim' is implemented.`);
            } finally {
                hideGlobalLoading();
            }
        }
        
        // --- Admin Tools Logic (SA Only - unchanged logic) ---
        
        const updateReservedTicketCounts = async () => {
            if (!isSuperAdmin && !isLoggedInAdmin) return;
            
            const infoDiv = document.getElementById('reservedTicketInfo');
            infoDiv.textContent = "Updating...";
            try {
                const getReservedTicketCountsCallable = httpsCallable(functions, 'getReservedTicketCounts');
                const response = await getReservedTicketCountsCallable({});
                const { totalReserved, expired5Min, expired10Min } = response.data;
                
                infoDiv.innerHTML = `
                    <p>Total Reserved Tickets: <span class="font-bold">${totalReserved}</span></p>
                    <p>Reserved > 5 Min (Expired by Cron): <span class="font-bold text-red-400">${expired5Min}</span></p>
                    <p>Reserved > 10 Min: <span class="font-bold text-red-400">${expired10Min}</span></p>
                `;
            } catch (error) {
                infoDiv.textContent = 'Failed to load ticket counts.';
                console.error("Error fetching ticket counts:", error);
            }
        };

        const handleCleanupClick = async () => {
            if (!isSuperAdmin) return;
            showGlobalLoading("Running manual ticket cleanup...");
            try {
                const deleteExpiredReservedTicketsCallable = httpsCallable(functions, 'deleteExpiredReservedTickets');
                const response = await deleteExpiredReservedTicketsCallable({});
                showCustomPopup('Cleanup Success', response.data.message);
                await updateReservedTicketCounts();
                await fetchDashboardData();
            } catch (error) {
                console.error("Error running cleanup:", error);
                showCustomPopup('Cleanup Failed', `Error: ${error.message}`);
            } finally {
                hideGlobalLoading();
            }
        };
        
        const handleRecalculateAllReferrerTotals = async () => {
            if (!isSuperAdmin) return;
            
            showGlobalLoading("Recalculating ALL Referrer totals...");
            try {
                const recalculateAllReferrerTotalsCallable = httpsCallable(functions, 'recalculateAllReferrerTotals');
                const response = await recalculateAllReferrerTotalsCallable({});
                showCustomPopup('Recalculation Complete', response.data.message);
                await fetchDashboardData(); 
            } catch (error) {
                console.error("Error recalculating all referrer totals:", error);
                showCustomPopup('Recalculation Failed', `Error: ${error.message}`);
            } finally {
                hideGlobalLoading();
            }
        };
        
        const handleRecalculateRaffleTotals = async () => {
            if (!isSuperAdmin) return;
            
            showGlobalLoading("Recalculating Split The Pot totals (Global Counter)...");
            try {
                const recalculateRaffleTotalsCallable = httpsCallable(functions, 'recalculateRaffleTotals');
                const response = await recalculateRaffleTotalsCallable({});
                showCustomPopup('Recalculation Complete', response.data.message);
                await fetchDashboardData(); 
            } catch (error) {
                console.error("Error recalculating raffle totals:", error);
                showCustomPopup('Recalculation Failed', `Error: ${error.message}`);
            } finally {
                hideGlobalLoading();
            }
        };

        const handleRecalculateRolexTotals = async () => {
            if (!isSuperAdmin) return;
            
            showGlobalLoading("Recalculating Spin The Wheel totals (Global Counter)...");
            try {
                const recalculateRolexTotalsCallable = httpsCallable(functions, 'recalculateRolexTotals');
                const response = await recalculateRolexTotalsCallable({});
                showCustomPopup('Recalculation Complete', response.data.message);
                await fetchDashboardData(); 

            } catch (error) {
                console.error("Error recalculating Rolex totals:", error);
                showCustomPopup('Recalculation Failed', `Error: ${error.message}`);
            } finally {
                hideGlobalLoading();
            }
        };

        // --- Export to CSV Logic (New Feature) ---

        const downloadCSV = (data, filename) => {
            // Generate CSV content
            if (!data || data.length === 0) {
                showCustomPopup('No Data', 'No data to export based on current view/filters.');
                return;
            }

            // Ensure all data items have the same fields for consistent header row
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(fieldName => {
                    let value = row[fieldName] === null || row[fieldName] === undefined ? '' : row[fieldName];

                    // Special handling for nested objects (e.g., Timestamps) and commas
                    if (typeof value === 'object') {
                        if (fieldName.toLowerCase().includes('date') || fieldName.toLowerCase().includes('timestamp') || fieldName.toLowerCase().includes('createdat')) {
                            // Use existing date formatter, remove internal commas
                            value = formatDate(value).replace(/,/g, ''); 
                        } else {
                            // Serialize object, replace internal commas with semicolons
                            value = JSON.stringify(value).replace(/,/g, ';'); 
                        }
                    } else if (typeof value === 'string') {
                        value = value.replace(/"/g, '""'); // Escape double quotes
                        if (value.includes(',')) {
                            value = `"${value}"`; // Enclose strings with commas in quotes
                        }
                    }
                    return value;
                }).join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) { 
                link.setAttribute("href", URL.createObjectURL(blob));
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showCustomPopup('Export Success', `Downloaded ${filename}`);
            } else {
                showCustomPopup('Export Error', 'Your browser does not support automatic CSV download.');
            }
        };


        const handleExportClick = () => {
            if (!isSuperAdmin) {
                 showCustomPopup('Permission Denied', 'Only Super Admins can export data.');
                 return;
            }
            let dataToExport = [];
            let filename = `export_${currentTab}_${new Date().toISOString().slice(0, 10)}.csv`;

            // Function to clone and clean data for export (remove internal IDs/UIDs)
            const cleanData = (data) => data.map(item => {
                // Deep clone to safely modify nested objects for display
                const cleaned = JSON.parse(JSON.stringify(item)); 
                delete cleaned.uid; 
                delete cleaned.referrerUid; 
                return cleaned;
            });

            switch (currentTab) {
                case 'users':
                    // User data includes special properties we need to clean up
                    dataToExport = filteredAuthUsers.map(u => ({
                        UID: u.uid,
                        Email: u.email,
                        DisplayName: u.displayName,
                        Is_Super_Admin: u.isSuperAdmin,
                        Is_Referrer: u.isReferrer,
                        Is_Disabled: u.disabled,
                        Email_Verified: u.emailVerified,
                        Created_At: u.createdAt,
                        Last_Sign_In: u.lastSignInTime
                    }));
                    break;
                case 'referrers':
                    dataToExport = cleanData(filterReferrers(dashboardData.referrers));
                    break;
                case 'raffle':
                    let filteredRaffle = filterSalesEntries(dashboardData.raffleEntries, raffleFilter);
                    if (activeRefIdFilter) {
                        filteredRaffle = filteredRaffle.filter(e => e.referrerRefId === activeRefIdFilter);
                    }
                    dataToExport = cleanData(sortEntries(filteredRaffle, raffleSortConfig));
                    break;
                case 'rolex':
                    let filteredRolex = filterSalesEntries(dashboardData.rolexEntries, rolexFilter);
                    if (activeRefIdFilter) {
                        filteredRolex = filteredRolex.filter(e => e.referrerRefId === activeRefIdFilter);
                    }
                    dataToExport = cleanData(sortEntries(filteredRolex, rolexSortConfig));
                    break;
                case 'donations':
                    // Donations respect the default sort (latest first)
                    dataToExport = cleanData(dashboardData.donationEntries);
                    dataToExport.sort((a, b) => getTimestampValue(b.createdAt) - getTimestampValue(a.createdAt));
                    break;
                default:
                    showCustomPopup('Export Failed', 'Please select a valid data tab to export.');
                    return;
            }
            
            if (dataToExport.length > 0) {
                downloadCSV(dataToExport, filename);
            } else {
                showCustomPopup('Export Failed', 'No data found based on current filters.');
            }
        };


        // --- Other Modal and Form Handlers (unchanged) ---

        const openManualSaleModal = () => {
            if (!isSuperAdmin) {
                window.showCustomPopup('Permission Denied', 'Only Super Admins can add manual sales.');
                return;
            }
            document.getElementById('manualSaleModalOverlay').classList.remove('hidden');
            document.getElementById('manualSaleForm').reset();
            // Show Ref ID field only for SA
            document.getElementById('manual-referrer-container').classList.remove('hidden');
        };

        const closeManualSaleModal = () => {
            document.getElementById('manualSaleModalOverlay').classList.add('hidden');
        };

        const handleManualSaleSubmit = async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('manual-name').value.trim();
            const email = document.getElementById('manual-email').value.trim();
            const phone = document.getElementById('manual-phone').value.trim();
            const ticketsBought = document.getElementById('manual-tickets').value.trim();
            const amount = document.getElementById('manual-amount').value.trim();
            const refId = document.getElementById('manual-refId').value.trim();

            if (!name || !ticketsBought || !amount) {
                window.showCustomPopup('Missing Fields', 'Name, Tickets Bought, and Amount Paid are required.');
                return;
            }

            closeManualSaleModal();
            showGlobalLoading("Adding manual entry...");

            try {
                const addManualSaleCallable = httpsCallable(functions, 'addManualSale');
                const response = await addManualSaleCallable({
                    name, email: email || null, phone: phone || null,
                    ticketsBought, amount, refId: refId || null
                });

                window.showCustomPopup('Success', response.data.message);
                await fetchDashboardData(); // Refresh dashboard data
            } catch (error) {
                console.error("Error adding manual sale:", error);
                window.showCustomPopup('Error', `Failed to add manual sale: ${error.message}`);
            } finally {
                hideGlobalLoading();
            }
        };


        // --- Split the Pot Assignment Logic (unchanged) ---

        const fetchAssignmentRaffleSales = async () => {
            showGlobalLoading("Fetching all Split the Pot sales...");
            try {
                allAssignmentRaffleSales = dashboardData.raffleEntries.map((sale, index) => ({
                    id: sale.id || `sale-${index}`, 
                    ...sale
                }));
                
                filteredRaffleSales = [...allAssignmentRaffleSales];
                selectedRaffleSaleIds.clear();
                updateApplyRaffleTicketsUI();

            } catch (error) {
                console.error("Error fetching assignment sales:", error);
                showCustomPopup('Error', `Failed to load sales: ${error.message}`);
            } finally {
                hideGlobalLoading();
            }
        };
        
        const openApplyRaffleTicketsModal = async (refId, refName) => {
            if (!isSuperAdmin) {
                showCustomPopup('Permission Denied', 'Only Super Admins can assign Split the Pot tickets.');
                return;
            }
            
            targetRaffleRefId = refId;
            targetRaffleRefName = refName;

            document.getElementById('targetReferrerName').textContent = refName;
            document.getElementById('targetReferrerId').textContent = refId;
            document.getElementById('unassignedSearchInput').value = '';
            
            await fetchAssignmentRaffleSales();
            
            document.getElementById('applyTicketsModalOverlay').classList.remove('hidden');
        };

        const closeApplyRaffleTicketsModal = () => {
            document.getElementById('applyTicketsModalOverlay').classList.add('hidden');
            targetRaffleRefId = null;
            targetRaffleRefName = null;
            allAssignmentRaffleSales = [];
            filteredRaffleSales = [];
            selectedRaffleSaleIds.clear();
        };

        const updateApplyRaffleTicketsUI = () => {
            const tbody = document.getElementById('unassignedSalesTableBody');
            tbody.innerHTML = '';
            const selectAllCheckbox = document.getElementById('selectAllUnassigned');
            const selectedCountDisplay = document.getElementById('selectedCountDisplay');
            const applyButton = document.getElementById('applyReferrerButton');
            
            selectAllCheckbox.checked = false;
            
            if (filteredRaffleSales.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-400">No Split the Pot sales found matching the criteria.</td></tr>';
                applyButton.disabled = true;
                selectedCountDisplay.textContent = '0 sales selected';
                return;
            }

            filteredRaffleSales.forEach(sale => {
                const isSelected = selectedRaffleSaleIds.has(sale.id);
                const customerName = sale.fullName || sale.name || sale.firstName || 'N/A';
                const contact = sale.email || sale.phoneNumber || 'N/A';

                const currentReferrerContent = sale.referrerRefId 
                    ? `<span class="font-mono text-xs px-2 py-1 bg-yellow-400/20 text-yellow-300 rounded">${sale.referrerRefId}</span>`
                    : '<span class="text-red-400">None</span>';


                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="text-center">
                        <input type="checkbox" data-sale-id="${sale.id}" class="raffle-sale-checkbox rounded text-blue-400 focus:ring-blue-400 bg-gray-700 border-gray-600" ${isSelected ? 'checked' : ''}>
                    </td>
                    <td>${formatDate(sale.timestamp)}</td>
                    <td>${customerName}</td>
                    <td>${contact}</td>
                    <td>${(sale.ticketCount || 0).toLocaleString()}</td>
                    <td class="text-right font-medium">${formatCurrency(sale.amountPaid || 0)}</td>
                    <td>${currentReferrerContent}</td> 
                `;
                tbody.appendChild(tr);
            });
            
            selectedCountDisplay.textContent = `${selectedRaffleSaleIds.size} sales selected`;
            applyButton.disabled = selectedRaffleSaleIds.size === 0;

            if (filteredRaffleSales.length > 0 && selectedRaffleSaleIds.size === filteredRaffleSales.length) {
                selectAllCheckbox.checked = true;
            }
        };

        const handleRaffleSearchChange = () => {
            const searchLower = document.getElementById('unassignedSearchInput').value.toLowerCase().trim();
            if (searchLower === '') {
                filteredRaffleSales = [...allAssignmentRaffleSales];
            } else {
                filteredRaffleSales = allAssignmentRaffleSales.filter(sale => {
                    const name = (sale.fullName || sale.name || sale.firstName || '').toLowerCase();
                    const email = (sale.email || '').toLowerCase();
                    const phone = (sale.phoneNumber || '').toLowerCase();
                    const currentRef = (sale.referrerRefId || '').toLowerCase(); 
                    return name.includes(searchLower) || email.includes(searchLower) || phone.includes(searchLower) || currentRef.includes(searchLower);
                });
            }
            updateApplyRaffleTicketsUI();
        };

        const handleRaffleCheckboxChange = (e) => {
            const saleId = e.target.dataset.saleId;
            if (e.target.checked) {
                selectedRaffleSaleIds.add(saleId);
            } else {
                selectedRaffleSaleIds.delete(saleId);
            }
            
            const selectAllCheckbox = document.getElementById('selectAllUnassigned');
            if (selectedRaffleSaleIds.size === filteredRaffleSales.length && filteredRaffleSales.length > 0) {
                selectAllCheckbox.checked = true;
            } else {
                selectAllCheckbox.checked = false;
            }

            document.getElementById('selectedCountDisplay').textContent = `${selectedRaffleSaleIds.size} sales selected`;
            document.getElementById('applyReferrerButton').disabled = selectedRaffleSaleIds.size === 0;
        };

        const handleRaffleSelectAllChange = (e) => {
            selectedRaffleSaleIds.clear();
            const isChecked = e.target.checked;

            document.querySelectorAll('.raffle-sale-checkbox').forEach(checkbox => {
                checkbox.checked = isChecked;
                const saleId = checkbox.dataset.saleId;
                if (isChecked) {
                    selectedRaffleSaleIds.add(saleId);
                }
            });

            document.getElementById('selectedCountDisplay').textContent = `${selectedRaffleSaleIds.size} sales selected`;
            document.getElementById('applyReferrerButton').disabled = selectedRaffleSaleIds.size === 0;
        };

        const applyReferrerToRaffleSales = async () => {
            if (!targetRaffleRefId || selectedRaffleSaleIds.size === 0) {
                showCustomPopup('Error', 'No referrer or sales selected.');
                return;
            }
            
            const salesToUpdate = Array.from(selectedRaffleSaleIds);
            const refId = targetRaffleRefId;
            
            closeApplyRaffleTicketsModal();
            showGlobalLoading(`Processing transfer/assignment of ${salesToUpdate.length} Split the Pot sales to ${refId}...`);

            try {
                const assignReferrerToSalesCallable = httpsCallable(functions, 'assignReferrerToSales');
                const response = await assignReferrerToSalesCallable({ saleIds: salesToUpdate, refId: refId });

                showCustomPopup('Success', response.data.message || `Successfully processed ${salesToUpdate.length} sales for ${refId}.`);
                
                await fetchDashboardData(); 

            } catch (error) {
                console.error("Error assigning referrer (Raffle):", error);
                showCustomPopup('Assignment/Transfer Failed', `Error: ${error.message}`);
            } finally {
                hideGlobalLoading();
            }
        };
        
        // --- Spin the Wheel (Rolex) Assignment Logic (unchanged) ---
        
        const fetchAssignmentRolexSales = async () => {
            showGlobalLoading("Fetching all Spin The Wheel tickets...");
            try {
                allAssignmentRolexSales = dashboardData.rolexEntries.map((ticket) => ({
                    id: ticket.id, // Ticket number is the ID
                    ...ticket
                }));
                
                filteredRolexSales = [...allAssignmentRolexSales];
                selectedRolexSaleIds.clear();
                updateApplyRolexTicketsUI();

            } catch (error) {
                console.error("Error fetching Rolex sales:", error);
                showCustomPopup('Error', `Failed to load Rolex tickets: ${error.message}`);
            } finally {
                hideGlobalLoading();
            }
        };

        const openApplyRolexTicketsModal = async (refId, refName) => {
            if (!isSuperAdmin) {
                showCustomPopup('Permission Denied', 'Only Super Admins can assign Spin The Wheel tickets.');
                return;
            }
            
            targetRolexRefId = refId;
            targetRolexRefName = refName;

            document.getElementById('targetRolexReferrerName').textContent = refName;
            document.getElementById('targetRolexReferrerId').textContent = refId;
            document.getElementById('rolexSearchInput').value = '';
            
            await fetchAssignmentRolexSales();
            
            document.getElementById('applyRolexTicketsModalOverlay').classList.remove('hidden');
        };
        
        const closeApplyRolexTicketsModal = () => {
            document.getElementById('applyRolexTicketsModalOverlay').classList.add('hidden');
            targetRolexRefId = null;
            targetRolexRefName = null;
            allAssignmentRolexSales = [];
            filteredRolexSales = [];
            selectedRolexSaleIds.clear();
        };
        
        const updateApplyRolexTicketsUI = () => {
            const tbody = document.getElementById('rolexAssignmentTableBody');
            tbody.innerHTML = '';
            const selectAllCheckbox = document.getElementById('selectAllRolex');
            const selectedCountDisplay = document.getElementById('selectedRolexCountDisplay');
            const applyButton = document.getElementById('applyRolexReferrerButton');
            
            selectAllCheckbox.checked = false;

            if (filteredRolexSales.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-400">No Paid or Claimed Spin The Wheel tickets found matching the criteria.</td></tr>';
                applyButton.disabled = true;
                selectedCountDisplay.textContent = '0 tickets selected';
                return;
            }

            filteredRolexSales.forEach(ticket => {
                const isSelected = selectedRolexSaleIds.has(ticket.id);
                const customerName = ticket.fullName || ticket.name || ticket.firstName || 'N/A';
                const contact = ticket.email || ticket.phoneNumber || 'N/A';
                // FIX: Variable name changed to currentReferrerContent
                const currentReferrerContent = ticket.referrerRefId 
                    ? `<span class="font-mono text-xs px-2 py-1 bg-yellow-400/20 text-yellow-300 rounded">${ticket.referrerRefId}</span>`
                    : '<span class="text-red-400">None</span>';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="text-center">
                        <input type="checkbox" data-ticket-id="${ticket.id}" class="rolex-ticket-checkbox rounded text-purple-400 focus:ring-purple-400 bg-gray-700 border-gray-600" ${isSelected ? 'checked' : ''}>
                    </td>
                    <td class="font-bold">${ticket.id}</td>
                    <td>${formatDate(ticket.timestamp)}</td>
                    <td>${customerName}</td>
                    <td>${contact}</td>
                    <td class="text-right font-medium">${formatCurrency(ticket.amountPaid || 0)}</td>
                    <td>${currentReferrerContent}</td> 
                `;
                tbody.appendChild(tr);
            });
            
            selectedCountDisplay.textContent = `${selectedRolexSaleIds.size} tickets selected`;
            applyButton.disabled = selectedRolexSaleIds.size === 0;

            if (filteredRolexSales.length > 0 && selectedRolexSaleIds.size === filteredRolexSales.length) {
                selectAllCheckbox.checked = true;
            }
        };

        const handleRolexSearchChange = () => {
            const searchLower = document.getElementById('rolexSearchInput').value.toLowerCase().trim();
            if (searchLower === '') {
                filteredRolexSales = [...allAssignmentRolexSales];
            } else {
                filteredRolexSales = allAssignmentRolexSales.filter(ticket => {
                    const name = (ticket.fullName || ticket.name || ticket.firstName || '').toLowerCase();
                    const email = (ticket.email || '').toLowerCase();
                    const currentRef = (ticket.referrerRefId || '').toLowerCase(); 
                    const id = String(ticket.id).toLowerCase();
                    return name.includes(searchLower) || email.includes(searchLower) || currentRef.includes(searchLower) || id.includes(searchLower);
                });
            }
            updateApplyRolexTicketsUI();
        };

        const handleRolexCheckboxChange = (e) => {
            const ticketId = e.target.dataset.ticketId;
            if (e.target.checked) {
                selectedRolexSaleIds.add(ticketId);
            } else {
                selectedRolexSaleIds.delete(ticketId);
            }
            
            const selectAllCheckbox = document.getElementById('selectAllRolex');
            if (selectedRolexSaleIds.size === filteredRolexSales.length && filteredRolexSales.length > 0) {
                selectAllCheckbox.checked = true;
            } else {
                selectAllCheckbox.checked = false;
            }

            document.getElementById('selectedRolexCountDisplay').textContent = `${selectedRolexSaleIds.size} tickets selected`;
            document.getElementById('applyRolexReferrerButton').disabled = selectedRolexSaleIds.size === 0;
        };

        const handleRolexSelectAllChange = (e) => {
            selectedRolexSaleIds.clear();
            const isChecked = e.target.checked;

            document.querySelectorAll('.rolex-ticket-checkbox').forEach(checkbox => {
                checkbox.checked = isChecked;
                const ticketId = checkbox.dataset.ticketId;
                if (isChecked) {
                    selectedRolexSaleIds.add(ticketId);
                }
            });

            document.getElementById('selectedRolexCountDisplay').textContent = `${selectedRolexSaleIds.size} tickets selected`;
            document.getElementById('applyRolexReferrerButton').disabled = selectedRolexSaleIds.size === 0;
        };

        const applyReferrerToRolexTickets = async () => {
            if (!targetRolexRefId || selectedRolexSaleIds.size === 0) {
                showCustomPopup('Error', 'No referrer or tickets selected.');
                return;
            }
            
            const ticketIds = Array.from(selectedRolexSaleIds);
            const refId = targetRolexRefId;
            
            closeApplyRolexTicketsModal();
            showGlobalLoading(`Processing transfer/assignment of ${ticketIds.length} Spin The Wheel tickets to ${refId}...`);

            try {
                const assignReferrerToRolexTicketsCallable = httpsCallable(functions, 'assignReferrerToRolexTickets');
                const response = await assignReferrerToRolexTicketsCallable({ ticketIds: ticketIds, refId: refId });

                showCustomPopup('Success', response.data.message || `Successfully processed ${ticketIds.length} tickets for ${refId}.`);
                
                await fetchDashboardData(); 

            } catch (error) {
                console.error("Error assigning referrer (Rolex):", error);
                showCustomPopup('Assignment/Transfer Failed', `Error: ${error.message}`);
            } finally {
                hideGlobalLoading();
            }
        };


        // --- Authentication and Initialization (unchanged login/logout) ---

        const setupAuthListeners = () => {
            onAuthStateChanged(auth, async (user) => {
                showGlobalLoading("Checking authorization...");
                if (user) {
                    const idTokenResult = await user.getIdTokenResult(true);
                    const claims = idTokenResult.claims;
                    
                    const isAuthenticated = claims.admin || claims.superAdmin || claims.referrer;

                    if (isAuthenticated) {
                        document.getElementById('loginModalOverlay').classList.add('hidden');
                        document.getElementById('dashboardContainer').classList.remove('hidden');
                        document.getElementById('authErrorDisplay').classList.add('hidden');
                        await fetchDashboardData();
                    } else {
                        document.getElementById('loginModalOverlay').classList.remove('hidden');
                        document.getElementById('dashboardContainer').classList.add('hidden');
                        document.getElementById('loginError').textContent = "Unauthorized. Please use an Admin/Referrer account.";
                        document.getElementById('loginError').classList.remove('hidden');
                        hideGlobalLoading();
                    }
                } else {
                    document.getElementById('dashboardContainer').classList.add('hidden');
                    document.getElementById('loginModalOverlay').classList.remove('hidden');
                    hideGlobalLoading();
                }
            });
        };
        
        const handleLogin = async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const loginError = document.getElementById('loginError');
            
            loginError.classList.add('hidden');
            document.getElementById('loginButton').disabled = true;

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Login failed:", error);
                loginError.textContent = "Login failed: Invalid credentials or account type.";
                loginError.classList.remove('hidden');
            } finally {
                document.getElementById('loginButton').disabled = false;
            }
        };

        const handleLogout = async () => {
            showGlobalLoading("Logging out...");
            try {
                await signOut(auth);
                document.getElementById('dashboardContainer').classList.add('hidden');
                document.getElementById('loginModalOverlay').classList.remove('hidden');
            } catch (error) {
                console.error("Logout failed:", error);
                window.showCustomPopup("Logout Failed", "Could not log out. Please try again.");
            } finally {
                hideGlobalLoading();
            }
        };
        
        // --- Event Listeners for Search and Sort Controls ---
        const attachSortAndSearchListeners = () => {
            // Referrer Table Search
            const searchInput = document.getElementById('referrerSearchInput');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    searchTerm = e.target.value;
                    renderReferrersTable(dashboardData.referrers);
                });
            }

            // User Table Search
            const userSearchInput = document.getElementById('userSearchInput');
            if (userSearchInput) {
                userSearchInput.addEventListener('input', handleUserSearchChange);
            }

            // User Table Sort
            document.querySelectorAll('.user-sort-header').forEach(header => {
                header.addEventListener('click', (e) => {
                    const key = e.currentTarget.dataset.sortKey;
                    if (userSortConfig.key === key) {
                        userSortConfig.direction = userSortConfig.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        userSortConfig.key = key;
                        userSortConfig.direction = (key === 'email' || key === 'displayName') ? 'asc' : 'desc';
                    }
                    renderAuthUsersTable(allAuthUsers);
                });
            });

            // Referrer Table Sort
            document.querySelectorAll('.referrer-sort-header').forEach(header => {
                header.addEventListener('click', (e) => {
                    const key = e.currentTarget.dataset.sortKey;
                    if (referrerSortConfig.key === key) {
                        referrerSortConfig.direction = referrerSortConfig.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        referrerSortConfig.key = key;
                        referrerSortConfig.direction = (key === 'name' || key === 'refId' || key === 'email') ? 'asc' : 'desc';
                    }
                    renderReferrersTable(dashboardData.referrers);
                });
            });
            
            // Sales Table Sorting (Raffle and Rolex)
            document.querySelectorAll('.sort-header').forEach(header => {
                header.addEventListener('click', (e) => {
                    const table = e.currentTarget.dataset.table;
                    const key = e.currentTarget.dataset.sortKey;
                    
                    let config = table === 'raffle' ? raffleSortConfig : rolexSortConfig;
                    let renderFunc = table === 'raffle' ? renderRaffleTable : renderRolexTable;
                    
                    if (config.key === key) {
                        config.direction = config.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        config.key = key;
                        // Default to ascending for strings, descending for numbers/dates
                        config.direction = (key === 'fullName' || key === 'referrerRefId' || key === 'name' || key === 'id') ? 'asc' : 'desc';
                    }
                    renderFunc(table === 'raffle' ? dashboardData.raffleEntries : dashboardData.rolexEntries);
                });
            });
            
            // Sales Table Filtering (Raffle)
            const raffleFilterElement = document.getElementById('raffleFilter');
            if (raffleFilterElement) {
                raffleFilterElement.addEventListener('change', (e) => {
                    raffleFilter = e.target.value;
                    // If a referrer filter is active, only update the raffle table, otherwise clear all filters.
                    if (!activeRefIdFilter) {
                        clearRefIdFilter(); 
                    } else {
                        renderRaffleTable(dashboardData.raffleEntries);
                    }
                });
            }
            
            // Sales Table Filtering (Rolex)
            const rolexFilterElement = document.getElementById('rolexFilter');
            if (rolexFilterElement) {
                rolexFilterElement.addEventListener('change', (e) => {
                    rolexFilter = e.target.value;
                    renderRolexTable(dashboardData.rolexEntries);
                });
            }
        };


        // --- Event Listeners and Initial Setup ---
        window.onload = async () => {
            try {
                // Initialize Firebase
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                functions = getFunctions(app);
                db = getFirestore(app);
                
                setLogLevel('debug');

                const refId = getRefIdFromUrl();
                if (refId) {
                    await trackRefClick(refId); 
                }

                setupAuthListeners();
                
                // Attach Event Listeners
                document.getElementById('loginForm').addEventListener('submit', handleLogin);
                document.getElementById('logoutButton').addEventListener('click', handleLogout);
                document.getElementById('popupCloseButton').addEventListener('click', hideCustomPopup);
                
                // NEW: Export Data Button
                document.getElementById('exportDataButton').addEventListener('click', handleExportClick);
                
                // NEW: Refresh Data Button
                document.getElementById('refreshDataButton').addEventListener('click', handleRefreshClick);

                // Tab navigation
                document.querySelectorAll('.tab-button').forEach(button => {
                    button.addEventListener('click', (e) => switchTab(e.target.dataset.tab));
                });
                
                // Attach Search and Sort listeners
                attachSortAndSearchListeners();
                
                // Manual Sale Modal listeners
                // Wrapping in an existence check for safety, though the HTML elements are now restored
                if (document.getElementById('addManualSaleButton')) {
                    document.getElementById('addManualSaleButton').addEventListener('click', openManualSaleModal);
                }
                if (document.getElementById('closeManualSaleModal')) {
                    document.getElementById('closeManualSaleModal').addEventListener('click', closeManualSaleModal);
                }
                if (document.getElementById('manualSaleForm')) {
                    document.getElementById('manualSaleForm').addEventListener('submit', handleManualSaleSubmit);
                }
                
                // Edit Sale Modal listeners
                if (document.getElementById('closeEditSaleModal')) {
                    document.getElementById('closeEditSaleModal').addEventListener('click', closeEditSaleModal);
                }
                if (document.getElementById('editSaleForm')) {
                    document.getElementById('editSaleForm').addEventListener('submit', handleEditSaleSubmit);
                }
                
                // Admin Tools listeners
                if (document.getElementById('deleteExpiredTicketsButton')) {
                    document.getElementById('deleteExpiredTicketsButton').addEventListener('click', handleCleanupClick);
                }
                
                if (document.getElementById('recalculateAllReferrerTotalsButton')) {
                    document.getElementById('recalculateAllReferrerTotalsButton').addEventListener('click', handleRecalculateAllReferrerTotals);
                }
                if (document.getElementById('recalculateTotalsButton')) {
                    document.getElementById('recalculateTotalsButton').addEventListener('click', handleRecalculateRaffleTotals);
                }
                if (document.getElementById('recalculateRolexTotalsButton')) {
                    document.getElementById('recalculateRolexTotalsButton').addEventListener('click', handleRecalculateRolexTotals); 
                }

                // --- Split the Pot Assignment Modal listeners ---
                if (document.getElementById('closeApplyTicketsModal')) {
                    document.getElementById('closeApplyTicketsModal').addEventListener('click', closeApplyRaffleTicketsModal);
                }
                if (document.getElementById('applyReferrerButton')) {
                    document.getElementById('applyReferrerButton').addEventListener('click', applyReferrerToRaffleSales);
                }
                if (document.getElementById('unassignedSearchInput')) {
                    document.getElementById('unassignedSearchInput').addEventListener('input', handleRaffleSearchChange);
                }
                if (document.getElementById('selectAllUnassigned')) {
                    document.getElementById('selectAllUnassigned').addEventListener('change', handleRaffleSelectAllChange);
                }
                
                if (document.getElementById('unassignedSalesTableBody')) {
                    document.getElementById('unassignedSalesTableBody').addEventListener('change', (e) => {
                        if (e.target.classList.contains('raffle-sale-checkbox')) {
                            handleRaffleCheckboxChange(e);
                        }
                    });
                }


                // --- Spin the Wheel (Rolex) Assignment Modal listeners ---
                if (document.getElementById('closeApplyRolexTicketsModal')) {
                    document.getElementById('closeApplyRolexTicketsModal').addEventListener('click', closeApplyRolexTicketsModal);
                }
                if (document.getElementById('applyRolexReferrerButton')) {
                    document.getElementById('applyRolexReferrerButton').addEventListener('click', applyReferrerToRolexTickets);
                }
                if (document.getElementById('rolexSearchInput')) {
                    document.getElementById('rolexSearchInput').addEventListener('input', handleRolexSearchChange);
                }
                if (document.getElementById('selectAllRolex')) {
                    document.getElementById('selectAllRolex').addEventListener('change', handleRolexSelectAllChange);
                }
                
                if (document.getElementById('rolexAssignmentTableBody')) {
                    document.getElementById('rolexAssignmentTableBody').addEventListener('change', (e) => {
                        if (e.target.classList.contains('rolex-ticket-checkbox')) {
                            handleRolexCheckboxChange(e);
                        }
                    });
                }

                // Upgrade Admin Modal listeners
                if (document.getElementById('closeUpgradeAdminModal')) {
                    document.getElementById('closeUpgradeAdminModal').addEventListener('click', closeUpgradeAdminModal);
                }
                if (document.getElementById('confirmUpgradeAdmin')) {
                    document.getElementById('confirmUpgradeAdmin').addEventListener('click', handleUpgradeAdmin);
                }

                // --- NEW USER MANAGEMENT LISTENERS ---
                if (document.getElementById('usersTableBody')) {
                    document.getElementById('usersTableBody').addEventListener('click', (e) => {
                        if (e.target.classList.contains('user-select-checkbox')) {
                            handleUserCheckboxChange(e);
                        }
                    });
                }
                if (document.getElementById('selectAllUsers')) {
                    document.getElementById('selectAllUsers').addEventListener('change', handleUserSelectAllChange);
                }
                if (document.getElementById('openBatchResetModalButton')) {
                    document.getElementById('openBatchResetModalButton').addEventListener('click', openBatchResetModal);
                }
                if (document.getElementById('closeBatchResetModal')) {
                    document.getElementById('closeBatchResetModal').addEventListener('click', closeBatchResetModal);
                }
                if (document.getElementById('batchResetForm')) {
                    document.getElementById('batchResetForm').addEventListener('submit', handleBatchResetSubmit);
                }
                // END NEW USER MANAGEMENT LISTENERS

                // Event delegation for Referrers Table clicks (Handles View Sales, Assign Raffle/Rolex, and Promote to SA)
                if (document.getElementById('referrersTableBody')) {
                    document.getElementById('referrersTableBody').addEventListener('click', (e) => {
                        const target = e.target;
                        const action = target.dataset.action;
                        
                        if (isSuperAdmin) {
                            const refId = target.dataset.refid;
                            const refName = target.dataset.refname;
                            const uid = target.dataset.uid;
                            
                            if (action === 'assign-raffle-tickets') {
                                openApplyRaffleTicketsModal(refId, refName);
                            } else if (action === 'assign-rolex-tickets') {
                                openApplyRolexTicketsModal(refId, refName);
                            } else if (action === 'view-referrer-sales') { 
                                // Unified filter for both Raffle and Rolex
                                openReferrerSalesModal(refId, refName);
                            } else if (action === 'promote-sa') {
                                openUpgradeAdminModal(uid, refName, refId);
                            }
                        }
                    });
                }

                // Event delegation for Raffle Sales Table clicks (for Edit button and Clear Filter button)
                if (document.getElementById('raffleTableBody')) {
                    document.getElementById('raffleTableBody').addEventListener('click', (e) => {
                        const target = e.target;
                        if (target.dataset.action === 'edit-sale' && isSuperAdmin) {
                            openEditSaleModal(target.dataset.entryId);
                        } else if (target.id === 'clearRaffleFilter') {
                            clearRefIdFilter();
                        }
                    });
                }
                
                // Event delegation for Rolex Sales Table clicks (for Clear Filter button)
                if (document.getElementById('rolexTableBody')) {
                    document.getElementById('rolexTableBody').addEventListener('click', (e) => {
                        const target = e.target;
                        if (target.id === 'clearRolexFilter') {
                            clearRefIdFilter();
                        }
                    });
                }


            } catch (error) {
                document.getElementById('globalSpinnerText').textContent = 'A critical error occurred during setup. Check the console for details.';
                console.error("Critical Application Error:", error);
                hideGlobalLoading();
            }
        };
    </script>
</body>
</html>
