<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YDE Senior Fund - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Bebas+Neue&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #0d1222;
            color: #e2e8f0; /* text-slate-200 */
        }
        .bebas-neue { font-family: 'Bebas Neue', sans-serif; }
        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        .card {
            background-color: #1e293b; /* slate-800 */
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
            border: 1px solid #334155; /* slate-700 */
        }
        .tab-button.active {
            border-bottom: 3px solid #fde047; /* yellow-400 */
            color: #fde047;
            font-weight: 700;
        }
        /* Style for tables */
        .data-table th, .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #334155;
        }
        .data-table th {
            background-color: #334155; /* slate-700 */
            color: #fde047;
            font-size: 0.85rem;
            text-transform: uppercase;
        }
        .data-table tr:last-child td {
            border-bottom: none;
        }
        .data-table-wrapper {
            max-height: 500px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="p-0 sm:p-4">

    <!-- Login Modal/Screen -->
    <div id="loginScreen" class="fixed inset-0 bg-gray-900 flex items-center justify-center z-50 p-4">
        <div class="card p-8 w-full max-w-sm text-center">
            <h2 class="bebas-neue text-3xl text-yellow-400 mb-6">Admin Login</h2>
            <input type="email" id="emailInput" placeholder="Email" class="w-full p-3 mb-3 bg-slate-700 border border-slate-600 rounded text-white focus:outline-none focus:ring-2 focus:ring-yellow-400">
            <input type="password" id="passwordInput" placeholder="Password" class="w-full p-3 mb-4 bg-slate-700 border border-slate-600 rounded text-white focus:outline-none focus:ring-2 focus:ring-yellow-400">
            <button id="loginButton" class="w-full py-3 bg-yellow-400 text-black font-bold rounded-lg hover:bg-yellow-500 transition duration-150">
                Sign In
            </button>
            <p id="loginError" class="text-red-400 text-sm mt-3 hidden">Login Failed.</p>
        </div>
    </div>
    
    <!-- Dashboard Container -->
    <div id="dashboard" class="dashboard-container hidden">
        <header class="mb-8 flex justify-between items-center border-b border-slate-700 pb-4">
            <h1 class="bebas-neue text-4xl text-yellow-400">Fundraising Dashboard</h1>
            <button id="logoutButton" class="text-sm text-red-400 hover:text-red-500 transition">Logout</button>
        </header>

        <!-- Referrer Goals/Summary (Visible for all logged-in users) -->
        <div id="referrerSummary" class="card p-6 mb-8 hidden">
            <h2 class="bebas-neue text-3xl text-white mb-4">Welcome, <span id="referrerNameDisplay" class="text-yellow-400"></span>!</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="p-4 bg-slate-700/50 rounded-lg">
                    <p class="text-sm font-semibold text-slate-400 uppercase">Your Tickets Sold</p>
                    <p id="myTicketsSold" class="bebas-neue text-4xl font-extrabold text-white mt-1">0</p>
                </div>
                <div class="p-4 bg-slate-700/50 rounded-lg">
                    <p class="text-sm font-semibold text-slate-400 uppercase">Your Amount Raised</p>
                    <p id="myAmountRaised" class="bebas-neue text-4xl font-extrabold text-green-400 mt-1">$0</p>
                </div>
                <div class="p-4 bg-slate-700/50 rounded-lg">
                    <p class="text-sm font-semibold text-slate-400 uppercase">Goal Progress</p>
                    <p id="myGoalText" class="text-lg font-semibold text-yellow-400 mb-1">0 / $0</p>
                    <div class="w-full bg-slate-600 rounded-full h-2.5">
                        <div id="goalProgressBar" class="bg-yellow-400 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Global Stats (SuperAdmin View) -->
        <div id="globalStats" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 hidden">
            <div class="card p-6">
                <p class="text-sm font-semibold text-slate-400 uppercase">Total Referral Tickets</p>
                <p id="totalTickets" class="bebas-neue text-5xl font-extrabold text-white mt-2">0</p>
            </div>
            <div class="card p-6">
                <p class="text-sm font-semibold text-slate-400 uppercase">Total Referral Amount</p>
                <p id="totalReferralAmount" class="bebas-neue text-5xl font-extrabold text-green-400 mt-2">$0</p>
            </div>
            <div class="card p-6">
                <p class="text-sm font-semibold text-slate-400 uppercase">Total Donations Raised</p>
                <p id="totalDonationAmount" class="bebas-neue text-5xl font-extrabold text-blue-400 mt-2">$0</p>
            </div>
        </div>

        <!-- Referrer Table (SuperAdmin View) -->
        <div id="referrerTableSection" class="card p-6 mb-8 hidden">
            <h2 class="text-2xl font-semibold text-white mb-4 border-b border-slate-700 pb-3">Referrer Leaderboard</h2>
            <div id="referrerTableWrapper" class="data-table-wrapper">
                <table class="w-full data-table">
                    <thead>
                        <tr>
                            <th>Referrer Name</th>
                            <th>Ref ID</th>
                            <th>Tickets Sold</th>
                            <th>Amount Raised</th>
                            <th>Goal</th>
                        </tr>
                    </thead>
                    <tbody id="referrerTableBody">
                        <!-- Referrer data will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Detailed Transactions Tabs (Visible for all logged-in users) -->
        <div id="transactionTabsSection" class="card p-6 hidden">
            <h2 class="text-2xl font-semibold text-white mb-4 border-b border-slate-700 pb-3">Transaction History</h2>
            <div class="flex border-b border-slate-700 mb-4">
                <button data-tab="rolex" class="tab-button active py-2 px-4 text-sm font-medium transition">Spin to Win (Rolex)</button>
                <button data-tab="raffle" class="tab-button py-2 px-4 text-sm font-medium transition">Split the Pot</button>
                <button data-tab="donations" class="tab-button py-2 px-4 text-sm font-medium transition">Donations</button>
            </div>

            <div id="tabContent">
                
                <!-- Rolex Tab -->
                <div id="rolex" class="tab-pane data-table-wrapper">
                    <table class="w-full data-table">
                        <thead>
                            <tr>
                                <th>Ticket #</th>
                                <th>Status</th>
                                <th>Amount Paid</th>
                                <th>Customer Name</th>
                                <th>Referrer ID</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody id="rolexTableBody">
                            <!-- Rolex transaction data will be inserted here -->
                        </tbody>
                    </table>
                </div>

                <!-- Raffle Tab -->
                <div id="raffle" class="tab-pane hidden data-table-wrapper">
                    <table class="w-full data-table">
                        <thead>
                            <tr>
                                <th>Customer Name</th>
                                <th>Tickets</th>
                                <th>Amount Paid</th>
                                <th>Referrer Name</th>
                                <th>Phone</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody id="raffleTableBody">
                            <!-- Raffle transaction data will be inserted here -->
                        </tbody>
                    </table>
                </div>

                <!-- Donations Tab -->
                <div id="donations" class="tab-pane hidden data-table-wrapper">
                    <table class="w-full data-table">
                        <thead>
                            <tr>
                                <th>Customer Name</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody id="donationsTableBody">
                            <!-- Donation transaction data will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="text-center mt-8 text-yellow-400 hidden">
            <svg class="animate-spin h-8 w-8 text-yellow-400 mx-auto mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p>Loading Dashboard Data...</p>
        </div>
        
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>

    <script>
        // --- Configuration ---
        const HARDCODED_PASSWORD = "YdeSeniorTest"; // Only used for initial script execution
        const ADMIN_EMAIL = "admin@ydefund.com"; // Placeholder - use your actual admin email

        // --- UI Elements ---
        const loginScreen = document.getElementById('loginScreen');
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const loginButton = document.getElementById('loginButton');
        const loginError = document.getElementById('loginError');
        const dashboard = document.getElementById('dashboard');
        const logoutButton = document.getElementById('logoutButton');
        const loadingIndicator = document.getElementById('loadingIndicator');

        // Referrer Specific
        const referrerSummary = document.getElementById('referrerSummary');
        const referrerNameDisplay = document.getElementById('referrerNameDisplay');
        const myTicketsSold = document.getElementById('myTicketsSold');
        const myAmountRaised = document.getElementById('myAmountRaised');
        const myGoalText = document.getElementById('myGoalText');
        const goalProgressBar = document.getElementById('goalProgressBar');

        // SuperAdmin Specific
        const globalStats = document.getElementById('globalStats');
        const totalTicketsEl = document.getElementById('totalTickets');
        const totalReferralAmountEl = document.getElementById('totalReferralAmount');
        const totalDonationAmountEl = document.getElementById('totalDonationAmount');
        const referrerTableSection = document.getElementById('referrerTableSection');
        
        // Tables
        const referrerTableBody = document.getElementById('referrerTableBody');
        const rolexTableBody = document.getElementById('rolexTableBody');
        const raffleTableBody = document.getElementById('raffleTableBody');
        const donationsTableBody = document.getElementById('donationsTableBody');
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabPanes = document.querySelectorAll('.tab-pane');
        const transactionTabsSection = document.getElementById('transactionTabsSection');


        // --- Firebase Initialization ---
        const firebaseConfig = {
            // NOTE: Insert your actual Firebase config here. The canvas environment will handle this if the global variable __firebase_config is used.
            apiKey: "AIzaSyAT539nr_s2OxHPTAmkxwMpaWt-FiDTgQs",
            authDomain: "yderaffle.firebaseapp.com",
            projectId: "yderaffle",
            storageBucket: "yderaffle.firebasestorage.app",
            messagingSenderId: "967768309102",
            appId: "1:967768309102:web:c89d61a747e8cb941f557f"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const functions = firebase.functions();
        const db = firebase.firestore();

        const getAdminDashboardDataCallable = functions.httpsCallable('getAdminDashboardData');

        // --- Helper Functions ---

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount || 0);
        }
        
        function formatTime(timestamp) {
            if (timestamp && timestamp.toDate) {
                return timestamp.toDate().toLocaleString();
            }
            return 'N/A';
        }

        function showDashboard() {
            loginScreen.classList.add('hidden');
            dashboard.classList.remove('hidden');
            loadingIndicator.classList.remove('hidden');
            fetchDashboardData();
        }

        function showLogin() {
            dashboard.classList.add('hidden');
            loginScreen.classList.remove('hidden');
        }

        function setActiveTab(tabId) {
            tabButtons.forEach(button => {
                button.classList.remove('active');
                if (button.getAttribute('data-tab') === tabId) {
                    button.classList.add('active');
                }
            });
            tabPanes.forEach(pane => {
                pane.classList.add('hidden');
                if (pane.id === tabId) {
                    pane.classList.remove('hidden');
                }
            });
        }
        
        // --- Render Functions ---
        
        function renderReferrerSummary(userData) {
            const tickets = userData.totalTickets || 0;
            const amount = userData.totalAmount || 0;
            const goal = userData.goal || 0;
            const progress = goal > 0 ? Math.min(100, (amount / goal) * 100) : 0;
            
            referrerNameDisplay.textContent = userData.name || 'Admin';
            myTicketsSold.textContent = tickets;
            myAmountRaised.textContent = formatCurrency(amount);
            myGoalText.textContent = `${formatCurrency(amount)} / ${formatCurrency(goal)} Goal`;
            goalProgressBar.style.width = `${progress}%`;
            
            referrerSummary.classList.remove('hidden');
        }

        function renderReferrers(referrers, isSuperAdmin) {
            if (!isSuperAdmin) {
                referrerTableSection.classList.add('hidden');
                return;
            }

            referrerTableBody.innerHTML = '';
            let totalAmount = 0;
            let totalTickets = 0;

            referrers.sort((a, b) => b.totalAmount - a.totalAmount).forEach(r => {
                totalAmount += r.totalAmount || 0;
                totalTickets += r.totalTickets || 0;
                
                const row = `
                    <tr class="hover:bg-slate-700 transition duration-100">
                        <td>${r.name}</td>
                        <td>${r.refId}</td>
                        <td>${r.totalTickets || 0}</td>
                        <td>${formatCurrency(r.totalAmount)}</td>
                        <td>${formatCurrency(r.goal)}</td>
                    </tr>
                `;
                referrerTableBody.insertAdjacentHTML('beforeend', row);
            });
            
            totalReferralAmountEl.textContent = formatCurrency(totalAmount);
            totalTicketsEl.textContent = totalTickets;
            globalStats.classList.remove('hidden');
            referrerTableSection.classList.remove('hidden');
        }

        function renderRolex(entries, isSuperAdmin) {
            rolexTableBody.innerHTML = '';
            // Only show the donation tab if Super Admin
            document.querySelector('[data-tab="donations"]').classList.toggle('hidden', !isSuperAdmin);

            entries.forEach(e => {
                const row = `
                    <tr>
                        <td>#${e.id}</td>
                        <td><span class="px-2 py-1 text-xs font-semibold rounded ${e.status === 'paid' ? 'bg-green-600' : e.status === 'reserved' ? 'bg-orange-500' : 'bg-blue-500'}">${e.status.toUpperCase()}</span></td>
                        <td>${formatCurrency(e.amountPaid || e.ticketNumber)}</td>
                        <td>${e.name || e.firstName}</td>
                        <td>${e.referrerRefId || 'N/A'}</td>
                        <td>${formatTime(e.timestamp)}</td>
                    </tr>
                `;
                rolexTableBody.insertAdjacentHTML('beforeend', row);
            });
            transactionTabsSection.classList.remove('hidden');
        }

        function renderRaffle(entries) {
            raffleTableBody.innerHTML = '';
            entries.forEach(e => {
                // Using new field names: firstName, ticketCount, amountPaid, phoneNumber
                const row = `
                    <tr>
                        <td>${e.firstName}</td>
                        <td>${e.ticketCount}</td>
                        <td>${formatCurrency(e.amountPaid)}</td>
                        <td>${e.referrerName || 'N/A'}</td>
                        <td>${e.phoneNumber || 'N/A'}</td>
                        <td>${formatTime(e.timestamp)}</td>
                    </tr>
                `;
                raffleTableBody.insertAdjacentHTML('beforeend', row);
            });
        }
        
        function renderDonations(entries, isSuperAdmin) {
            if (!isSuperAdmin) {
                // Hide the donation tab content for non-SuperAdmins
                document.getElementById('donations').classList.add('hidden');
                return;
            }

            donationsTableBody.innerHTML = '';
            let totalDonationAmount = 0;

            entries.forEach(e => {
                if (e.status === 'succeeded') {
                    totalDonationAmount += e.amountPaid || parseFloat(e.amount);
                }
                const statusColor = e.status === 'succeeded' ? 'bg-green-600' : 'bg-red-600';
                
                const row = `
                    <tr>
                        <td>${e.name}</td>
                        <td>${formatCurrency(e.amountPaid || parseFloat(e.amount))}</td>
                        <td><span class="px-2 py-1 text-xs font-semibold rounded ${statusColor}">${e.status.toUpperCase()}</span></td>
                        <td>${formatTime(e.createdAt)}</td>
                    </tr>
                `;
                donationsTableBody.insertAdjacentHTML('beforeend', row);
            });
            totalDonationAmountEl.textContent = formatCurrency(totalDonationAmount);
        }

        // --- Data Fetching ---
        async function fetchDashboardData() {
            loadingIndicator.classList.remove('hidden');

            try {
                const { data } = await getAdminDashboardDataCallable();
                
                const { 
                    isSuperAdmin, 
                    isReferrer, 
                    userData, 
                    referrers, 
                    rolexEntries, 
                    raffleEntries, 
                    donationEntries 
                } = data;

                // 1. Render Referrer Summary (for Referrers and Super Admins)
                if (isReferrer || isSuperAdmin) {
                    const summaryData = isReferrer && !isSuperAdmin ? userData : { 
                        name: 'Super Admin',
                        totalTickets: referrers.reduce((sum, r) => sum + (r.totalTickets || 0), 0),
                        totalAmount: referrers.reduce((sum, r) => sum + (r.totalAmount || 0), 0),
                        goal: 0 
                    };
                    renderReferrerSummary(summaryData);
                } else {
                    referrerSummary.classList.add('hidden');
                }

                // 2. Render SuperAdmin specific sections
                renderReferrers(referrers, isSuperAdmin);
                
                // 3. Render Transaction Tables
                renderRolex(rolexEntries, isSuperAdmin);
                renderRaffle(raffleEntries);
                renderDonations(donationEntries, isSuperAdmin);
                
                // Initial tab display
                setActiveTab('rolex');

            } catch (error) {
                console.error("Error fetching dashboard data:", error);
                loginError.textContent = `Failed to load dashboard: ${error.message}. Please check your role/rules.`;
                loginError.classList.remove('hidden');
                auth.signOut();
                showLogin();
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }
        
        // --- Authentication Logic ---

        async function handleLogin() {
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();
            loginError.classList.add('hidden');
            
            if (!email || !password) {
                loginError.textContent = "Please enter both email and password.";
                loginError.classList.remove('hidden');
                return;
            }

            try {
                await auth.signInWithEmailAndPassword(email, password);
                // AuthStateChanged listener handles the rest
            } catch (error) {
                console.error("Login Error:", error);
                loginError.textContent = "Sign-in failed. Check credentials and console.";
                loginError.classList.remove('hidden');
            }
        }
        
        function handleLogout() {
            auth.signOut();
            showLogin();
        }
        
        // --- Event Handlers ---

        loginButton.addEventListener('click', handleLogin);
        
        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') { handleLogin(); }
        });
        emailInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') { handleLogin(); }
        });
        
        logoutButton.addEventListener('click', handleLogout);

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                setActiveTab(button.getAttribute('data-tab'));
            });
        });

        // --- Auth State Listener ---
        auth.onAuthStateChanged(user => {
            if (user) {
                // User is signed in. Check custom claims are propagated.
                // Firebase automatically refreshes the token to include claims after sign-in.
                showDashboard();
            } else {
                // User is signed out.
                showLogin();
            }
        });
    </script>
</body>
</html>
